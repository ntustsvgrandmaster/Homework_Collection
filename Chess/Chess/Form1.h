#pragma once
//#include <fstream>
#include<string>
#include "GameManager.h"
//std::ifstream load;
//std::ofstream save;
int lastButtonIndex = -1;

std::string mode = "human";			//不能用受控型別string ，???為啥阿		//初始化要在load還是建構子?		//受控非受控的問題，暫且放在全域。
bool gameOver = false;
Player* nowPlaying;
GameManager gm(mode);			//創建控制者物件
std::string seq = "move";		//move 還是 move2
Position upPos;
int secondWhite = 3600;		// 一小時
int secondBlack = 3600;		// 一小時
std::string whoFirst = "White";

namespace Chess {

	using namespace System;
	using namespace System::ComponentModel;
	using namespace System::Collections;
	using namespace System::Windows::Forms;
	using namespace System::Data;
	using namespace System::Drawing;
	using namespace System::IO;

	/// <summary>
	/// Zusammenfassung fr Form1
	/// </summary>
	public ref class Form1 : public System::Windows::Forms::Form
	{
	public:
		Form1(void)
		{
			InitializeComponent();
			//
			//TODO: Konstruktorcode hier hinzufgen.
			//
		}

	protected:
		/// <summary>
		/// Verwendete Ressourcen bereinigen.
		/// </summary>
		~Form1()
		{
			if (components)
			{
				delete components;
			}
		}
	private: System::Windows::Forms::Button^ button1;
	protected:
	private: System::Windows::Forms::Button^ button2;
	private: System::Windows::Forms::Button^ button3;
	private: System::Windows::Forms::Button^ button4;
	private: System::Windows::Forms::Button^ button5;
	private: System::Windows::Forms::Button^ button6;
	private: System::Windows::Forms::Button^ button7;
	private: System::Windows::Forms::Button^ button8;
	private: System::Windows::Forms::Button^ button9;
	private: System::Windows::Forms::Button^ button10;
	private: System::Windows::Forms::Button^ button11;
	private: System::Windows::Forms::Button^ button12;
	private: System::Windows::Forms::Button^ button13;
	private: System::Windows::Forms::Button^ button14;
	private: System::Windows::Forms::Button^ button15;
	private: System::Windows::Forms::Button^ button16;
	private: System::Windows::Forms::Button^ button17;
	private: System::Windows::Forms::Button^ button18;
	private: System::Windows::Forms::Button^ button20;
	private: System::Windows::Forms::Button^ button19;
	private: System::Windows::Forms::Button^ button24;
	private: System::Windows::Forms::Button^ button23;
	private: System::Windows::Forms::Button^ button22;
	private: System::Windows::Forms::Button^ button21;
	private: System::Windows::Forms::Button^ button25;
	private: System::Windows::Forms::Button^ button26;
	private: System::Windows::Forms::Button^ button27;
	private: System::Windows::Forms::Button^ button28;
	private: System::Windows::Forms::Button^ button29;
	private: System::Windows::Forms::Button^ button30;
	private: System::Windows::Forms::Button^ button31;
	private: System::Windows::Forms::Button^ button32;
	private: System::Windows::Forms::Button^ button48;
	private: System::Windows::Forms::Button^ button47;
	private: System::Windows::Forms::Button^ button46;
	private: System::Windows::Forms::Button^ button45;
	private: System::Windows::Forms::Button^ button44;
	private: System::Windows::Forms::Button^ button43;
	private: System::Windows::Forms::Button^ button42;
	private: System::Windows::Forms::Button^ button41;
	private: System::Windows::Forms::Button^ button40;
	private: System::Windows::Forms::Button^ button39;
	private: System::Windows::Forms::Button^ button38;
	private: System::Windows::Forms::Button^ button37;
	private: System::Windows::Forms::Button^ button36;
	private: System::Windows::Forms::Button^ button35;
	private: System::Windows::Forms::Button^ button34;
	private: System::Windows::Forms::Button^ button33;
	private: System::Windows::Forms::Button^ button49;
	private: System::Windows::Forms::Button^ button50;
	private: System::Windows::Forms::Button^ button52;
	private: System::Windows::Forms::Button^ button51;
	private: System::Windows::Forms::Button^ button56;
	private: System::Windows::Forms::Button^ button55;
	private: System::Windows::Forms::Button^ button54;
	private: System::Windows::Forms::Button^ button53;
	private: System::Windows::Forms::Button^ button57;
	private: System::Windows::Forms::Button^ button58;
	private: System::Windows::Forms::Button^ button59;
	private: System::Windows::Forms::Button^ button60;
	private: System::Windows::Forms::Button^ button61;
	private: System::Windows::Forms::Button^ button62;
	private: System::Windows::Forms::Button^ button63;
	private: System::Windows::Forms::Button^ button64;
	private: System::Windows::Forms::Button^ button65;
	private: System::Windows::Forms::GroupBox^ groupBox1;
	private: System::Windows::Forms::Label^ label1;
	private: System::Windows::Forms::Label^ label2;
	private: System::Windows::Forms::Label^ label3;
	private: System::Windows::Forms::Label^ label4;
	private: System::Windows::Forms::Label^ label5;
	private: System::Windows::Forms::Label^ label6;
	private: System::Windows::Forms::GroupBox^ groupBox2;
	private: System::Windows::Forms::Button^ button66;
	private: System::Windows::Forms::PictureBox^ pictureBox1;
	private: System::Windows::Forms::Button^ button67;
	private: System::Windows::Forms::Button^ button68;
	private: System::Windows::Forms::Button^ button69;
	private: System::Windows::Forms::Button^ button70;
	private: System::Windows::Forms::PictureBox^ pictureBox3;
	private: System::Windows::Forms::Button^ button71;
	private: System::Windows::Forms::Button^ button72;
	private: System::Windows::Forms::Button^ button73;
	private: System::Windows::Forms::Button^ button74;
private: System::Windows::Forms::Timer^ timer1;
private: System::Windows::Forms::Timer^ timer2;
private: System::ComponentModel::IContainer^ components;

		   //會用到的變數
	private:



	protected:

	private:
		/// <summary>
		/// Erforderliche Designervariable.
		/// </summary>


#pragma region Windows Form Designer generated code
		/// <summary>
		/// Erforderliche Methode fr die Designeruntersttzung.
		/// Der Inhalt der Methode darf nicht mit dem Code-Editor ge鄚dert werden.
		/// </summary>
		void InitializeComponent(void)
		{
			this->components = (gcnew System::ComponentModel::Container());
			System::ComponentModel::ComponentResourceManager^ resources = (gcnew System::ComponentModel::ComponentResourceManager(Form1::typeid));
			this->button1 = (gcnew System::Windows::Forms::Button());
			this->button2 = (gcnew System::Windows::Forms::Button());
			this->button3 = (gcnew System::Windows::Forms::Button());
			this->button4 = (gcnew System::Windows::Forms::Button());
			this->button5 = (gcnew System::Windows::Forms::Button());
			this->button6 = (gcnew System::Windows::Forms::Button());
			this->button7 = (gcnew System::Windows::Forms::Button());
			this->button8 = (gcnew System::Windows::Forms::Button());
			this->button9 = (gcnew System::Windows::Forms::Button());
			this->button10 = (gcnew System::Windows::Forms::Button());
			this->button11 = (gcnew System::Windows::Forms::Button());
			this->button12 = (gcnew System::Windows::Forms::Button());
			this->button13 = (gcnew System::Windows::Forms::Button());
			this->button14 = (gcnew System::Windows::Forms::Button());
			this->button15 = (gcnew System::Windows::Forms::Button());
			this->button16 = (gcnew System::Windows::Forms::Button());
			this->button17 = (gcnew System::Windows::Forms::Button());
			this->button18 = (gcnew System::Windows::Forms::Button());
			this->button20 = (gcnew System::Windows::Forms::Button());
			this->button19 = (gcnew System::Windows::Forms::Button());
			this->button24 = (gcnew System::Windows::Forms::Button());
			this->button23 = (gcnew System::Windows::Forms::Button());
			this->button22 = (gcnew System::Windows::Forms::Button());
			this->button21 = (gcnew System::Windows::Forms::Button());
			this->button25 = (gcnew System::Windows::Forms::Button());
			this->button26 = (gcnew System::Windows::Forms::Button());
			this->button27 = (gcnew System::Windows::Forms::Button());
			this->button28 = (gcnew System::Windows::Forms::Button());
			this->button29 = (gcnew System::Windows::Forms::Button());
			this->button30 = (gcnew System::Windows::Forms::Button());
			this->button31 = (gcnew System::Windows::Forms::Button());
			this->button32 = (gcnew System::Windows::Forms::Button());
			this->button48 = (gcnew System::Windows::Forms::Button());
			this->button47 = (gcnew System::Windows::Forms::Button());
			this->button46 = (gcnew System::Windows::Forms::Button());
			this->button45 = (gcnew System::Windows::Forms::Button());
			this->button44 = (gcnew System::Windows::Forms::Button());
			this->button43 = (gcnew System::Windows::Forms::Button());
			this->button42 = (gcnew System::Windows::Forms::Button());
			this->button41 = (gcnew System::Windows::Forms::Button());
			this->button40 = (gcnew System::Windows::Forms::Button());
			this->button39 = (gcnew System::Windows::Forms::Button());
			this->button38 = (gcnew System::Windows::Forms::Button());
			this->button37 = (gcnew System::Windows::Forms::Button());
			this->button36 = (gcnew System::Windows::Forms::Button());
			this->button35 = (gcnew System::Windows::Forms::Button());
			this->button34 = (gcnew System::Windows::Forms::Button());
			this->button33 = (gcnew System::Windows::Forms::Button());
			this->button49 = (gcnew System::Windows::Forms::Button());
			this->button50 = (gcnew System::Windows::Forms::Button());
			this->button52 = (gcnew System::Windows::Forms::Button());
			this->button51 = (gcnew System::Windows::Forms::Button());
			this->button56 = (gcnew System::Windows::Forms::Button());
			this->button55 = (gcnew System::Windows::Forms::Button());
			this->button54 = (gcnew System::Windows::Forms::Button());
			this->button53 = (gcnew System::Windows::Forms::Button());
			this->button57 = (gcnew System::Windows::Forms::Button());
			this->button58 = (gcnew System::Windows::Forms::Button());
			this->button59 = (gcnew System::Windows::Forms::Button());
			this->button60 = (gcnew System::Windows::Forms::Button());
			this->button61 = (gcnew System::Windows::Forms::Button());
			this->button62 = (gcnew System::Windows::Forms::Button());
			this->button63 = (gcnew System::Windows::Forms::Button());
			this->button64 = (gcnew System::Windows::Forms::Button());
			this->button65 = (gcnew System::Windows::Forms::Button());
			this->groupBox1 = (gcnew System::Windows::Forms::GroupBox());
			this->label1 = (gcnew System::Windows::Forms::Label());
			this->label2 = (gcnew System::Windows::Forms::Label());
			this->label3 = (gcnew System::Windows::Forms::Label());
			this->label4 = (gcnew System::Windows::Forms::Label());
			this->label5 = (gcnew System::Windows::Forms::Label());
			this->label6 = (gcnew System::Windows::Forms::Label());
			this->groupBox2 = (gcnew System::Windows::Forms::GroupBox());
			this->button66 = (gcnew System::Windows::Forms::Button());
			this->pictureBox1 = (gcnew System::Windows::Forms::PictureBox());
			this->button67 = (gcnew System::Windows::Forms::Button());
			this->button68 = (gcnew System::Windows::Forms::Button());
			this->button69 = (gcnew System::Windows::Forms::Button());
			this->button70 = (gcnew System::Windows::Forms::Button());
			this->pictureBox3 = (gcnew System::Windows::Forms::PictureBox());
			this->button71 = (gcnew System::Windows::Forms::Button());
			this->button72 = (gcnew System::Windows::Forms::Button());
			this->button73 = (gcnew System::Windows::Forms::Button());
			this->button74 = (gcnew System::Windows::Forms::Button());
			this->timer1 = (gcnew System::Windows::Forms::Timer(this->components));
			this->timer2 = (gcnew System::Windows::Forms::Timer(this->components));
			this->groupBox1->SuspendLayout();
			this->groupBox2->SuspendLayout();
			(cli::safe_cast<System::ComponentModel::ISupportInitialize^>(this->pictureBox1))->BeginInit();
			(cli::safe_cast<System::ComponentModel::ISupportInitialize^>(this->pictureBox3))->BeginInit();
			this->SuspendLayout();
			// 
			// button1
			// 
			this->button1->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button1->FlatAppearance->BorderSize = 0;
			this->button1->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button1->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button1.Image")));
			this->button1->Location = System::Drawing::Point(22, 17);
			this->button1->Name = L"button1";
			this->button1->Size = System::Drawing::Size(130, 130);
			this->button1->TabIndex = 0;
			this->button1->UseVisualStyleBackColor = false;
			this->button1->Click += gcnew System::EventHandler(this, &Form1::button1_Click);
			// 
			// button2
			// 
			this->button2->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button2->FlatAppearance->BorderSize = 0;
			this->button2->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button2->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button2.Image")));
			this->button2->Location = System::Drawing::Point(152, 17);
			this->button2->Name = L"button2";
			this->button2->Size = System::Drawing::Size(130, 130);
			this->button2->TabIndex = 1;
			this->button2->UseVisualStyleBackColor = false;
			this->button2->Click += gcnew System::EventHandler(this, &Form1::button2_Click);
			// 
			// button3
			// 
			this->button3->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button3->FlatAppearance->BorderSize = 0;
			this->button3->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button3->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button3.Image")));
			this->button3->Location = System::Drawing::Point(282, 17);
			this->button3->Name = L"button3";
			this->button3->Size = System::Drawing::Size(130, 130);
			this->button3->TabIndex = 2;
			this->button3->UseVisualStyleBackColor = false;
			this->button3->Click += gcnew System::EventHandler(this, &Form1::button3_Click);
			// 
			// button4
			// 
			this->button4->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button4->FlatAppearance->BorderSize = 0;
			this->button4->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button4->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button4.Image")));
			this->button4->Location = System::Drawing::Point(412, 17);
			this->button4->Name = L"button4";
			this->button4->Size = System::Drawing::Size(130, 130);
			this->button4->TabIndex = 3;
			this->button4->UseVisualStyleBackColor = false;
			this->button4->Click += gcnew System::EventHandler(this, &Form1::button4_Click);
			// 
			// button5
			// 
			this->button5->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button5->FlatAppearance->BorderSize = 0;
			this->button5->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button5->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button5.Image")));
			this->button5->Location = System::Drawing::Point(542, 17);
			this->button5->Name = L"button5";
			this->button5->Size = System::Drawing::Size(130, 130);
			this->button5->TabIndex = 4;
			this->button5->UseVisualStyleBackColor = false;
			this->button5->Click += gcnew System::EventHandler(this, &Form1::button5_Click);
			// 
			// button6
			// 
			this->button6->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button6->FlatAppearance->BorderSize = 0;
			this->button6->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button6->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button6.Image")));
			this->button6->Location = System::Drawing::Point(672, 17);
			this->button6->Name = L"button6";
			this->button6->Size = System::Drawing::Size(130, 130);
			this->button6->TabIndex = 5;
			this->button6->UseVisualStyleBackColor = false;
			this->button6->Click += gcnew System::EventHandler(this, &Form1::button6_Click);
			// 
			// button7
			// 
			this->button7->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button7->FlatAppearance->BorderSize = 0;
			this->button7->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button7->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button7.Image")));
			this->button7->Location = System::Drawing::Point(802, 17);
			this->button7->Name = L"button7";
			this->button7->Size = System::Drawing::Size(130, 130);
			this->button7->TabIndex = 6;
			this->button7->UseVisualStyleBackColor = false;
			this->button7->Click += gcnew System::EventHandler(this, &Form1::button7_Click);
			// 
			// button8
			// 
			this->button8->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button8->FlatAppearance->BorderSize = 0;
			this->button8->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button8->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button8.Image")));
			this->button8->Location = System::Drawing::Point(932, 17);
			this->button8->Name = L"button8";
			this->button8->Size = System::Drawing::Size(130, 130);
			this->button8->TabIndex = 7;
			this->button8->UseVisualStyleBackColor = false;
			this->button8->Click += gcnew System::EventHandler(this, &Form1::button8_Click);
			// 
			// button9
			// 
			this->button9->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button9->FlatAppearance->BorderSize = 0;
			this->button9->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button9->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button9.Image")));
			this->button9->Location = System::Drawing::Point(22, 147);
			this->button9->Name = L"button9";
			this->button9->Size = System::Drawing::Size(130, 130);
			this->button9->TabIndex = 8;
			this->button9->UseVisualStyleBackColor = false;
			this->button9->Click += gcnew System::EventHandler(this, &Form1::button9_Click);
			// 
			// button10
			// 
			this->button10->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button10->FlatAppearance->BorderSize = 0;
			this->button10->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button10->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button10.Image")));
			this->button10->Location = System::Drawing::Point(152, 147);
			this->button10->Name = L"button10";
			this->button10->Size = System::Drawing::Size(130, 130);
			this->button10->TabIndex = 9;
			this->button10->UseVisualStyleBackColor = false;
			this->button10->Click += gcnew System::EventHandler(this, &Form1::button10_Click);
			// 
			// button11
			// 
			this->button11->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button11->FlatAppearance->BorderSize = 0;
			this->button11->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button11->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button11.Image")));
			this->button11->Location = System::Drawing::Point(282, 147);
			this->button11->Name = L"button11";
			this->button11->Size = System::Drawing::Size(130, 130);
			this->button11->TabIndex = 10;
			this->button11->UseVisualStyleBackColor = false;
			this->button11->Click += gcnew System::EventHandler(this, &Form1::button11_Click);
			// 
			// button12
			// 
			this->button12->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button12->FlatAppearance->BorderSize = 0;
			this->button12->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button12->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button12.Image")));
			this->button12->Location = System::Drawing::Point(412, 147);
			this->button12->Name = L"button12";
			this->button12->Size = System::Drawing::Size(130, 130);
			this->button12->TabIndex = 11;
			this->button12->UseVisualStyleBackColor = false;
			this->button12->Click += gcnew System::EventHandler(this, &Form1::button12_Click);
			// 
			// button13
			// 
			this->button13->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button13->FlatAppearance->BorderSize = 0;
			this->button13->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button13->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button13.Image")));
			this->button13->Location = System::Drawing::Point(542, 147);
			this->button13->Name = L"button13";
			this->button13->Size = System::Drawing::Size(130, 130);
			this->button13->TabIndex = 12;
			this->button13->UseVisualStyleBackColor = false;
			this->button13->Click += gcnew System::EventHandler(this, &Form1::button13_Click);
			// 
			// button14
			// 
			this->button14->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button14->FlatAppearance->BorderSize = 0;
			this->button14->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button14->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button14.Image")));
			this->button14->Location = System::Drawing::Point(672, 147);
			this->button14->Name = L"button14";
			this->button14->Size = System::Drawing::Size(130, 130);
			this->button14->TabIndex = 13;
			this->button14->UseVisualStyleBackColor = false;
			this->button14->Click += gcnew System::EventHandler(this, &Form1::button14_Click);
			// 
			// button15
			// 
			this->button15->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button15->FlatAppearance->BorderSize = 0;
			this->button15->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button15->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button15.Image")));
			this->button15->Location = System::Drawing::Point(802, 147);
			this->button15->Name = L"button15";
			this->button15->Size = System::Drawing::Size(130, 130);
			this->button15->TabIndex = 14;
			this->button15->UseVisualStyleBackColor = false;
			this->button15->Click += gcnew System::EventHandler(this, &Form1::button15_Click);
			// 
			// button16
			// 
			this->button16->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button16->FlatAppearance->BorderSize = 0;
			this->button16->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button16->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button16.Image")));
			this->button16->Location = System::Drawing::Point(932, 147);
			this->button16->Name = L"button16";
			this->button16->Size = System::Drawing::Size(130, 130);
			this->button16->TabIndex = 15;
			this->button16->UseVisualStyleBackColor = false;
			this->button16->Click += gcnew System::EventHandler(this, &Form1::button16_Click);
			// 
			// button17
			// 
			this->button17->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button17->FlatAppearance->BorderSize = 0;
			this->button17->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button17->Location = System::Drawing::Point(22, 277);
			this->button17->Name = L"button17";
			this->button17->Size = System::Drawing::Size(130, 130);
			this->button17->TabIndex = 16;
			this->button17->UseVisualStyleBackColor = false;
			this->button17->Click += gcnew System::EventHandler(this, &Form1::button17_Click);
			// 
			// button18
			// 
			this->button18->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button18->FlatAppearance->BorderSize = 0;
			this->button18->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button18->Location = System::Drawing::Point(152, 277);
			this->button18->Name = L"button18";
			this->button18->Size = System::Drawing::Size(130, 130);
			this->button18->TabIndex = 17;
			this->button18->UseVisualStyleBackColor = false;
			this->button18->Click += gcnew System::EventHandler(this, &Form1::button18_Click);
			// 
			// button20
			// 
			this->button20->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button20->FlatAppearance->BorderSize = 0;
			this->button20->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button20->Location = System::Drawing::Point(412, 277);
			this->button20->Name = L"button20";
			this->button20->Size = System::Drawing::Size(130, 130);
			this->button20->TabIndex = 19;
			this->button20->UseVisualStyleBackColor = false;
			this->button20->Click += gcnew System::EventHandler(this, &Form1::button20_Click);
			// 
			// button19
			// 
			this->button19->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button19->FlatAppearance->BorderSize = 0;
			this->button19->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button19->Location = System::Drawing::Point(282, 277);
			this->button19->Name = L"button19";
			this->button19->Size = System::Drawing::Size(130, 130);
			this->button19->TabIndex = 18;
			this->button19->UseVisualStyleBackColor = false;
			this->button19->Click += gcnew System::EventHandler(this, &Form1::button19_Click);
			// 
			// button24
			// 
			this->button24->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button24->FlatAppearance->BorderSize = 0;
			this->button24->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button24->Location = System::Drawing::Point(932, 277);
			this->button24->Name = L"button24";
			this->button24->Size = System::Drawing::Size(130, 130);
			this->button24->TabIndex = 23;
			this->button24->UseVisualStyleBackColor = false;
			this->button24->Click += gcnew System::EventHandler(this, &Form1::button24_Click);
			// 
			// button23
			// 
			this->button23->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button23->FlatAppearance->BorderSize = 0;
			this->button23->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button23->Location = System::Drawing::Point(802, 277);
			this->button23->Name = L"button23";
			this->button23->Size = System::Drawing::Size(130, 130);
			this->button23->TabIndex = 22;
			this->button23->UseVisualStyleBackColor = false;
			this->button23->Click += gcnew System::EventHandler(this, &Form1::button23_Click);
			// 
			// button22
			// 
			this->button22->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button22->FlatAppearance->BorderSize = 0;
			this->button22->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button22->Location = System::Drawing::Point(672, 277);
			this->button22->Name = L"button22";
			this->button22->Size = System::Drawing::Size(130, 130);
			this->button22->TabIndex = 21;
			this->button22->UseVisualStyleBackColor = false;
			this->button22->Click += gcnew System::EventHandler(this, &Form1::button22_Click);
			// 
			// button21
			// 
			this->button21->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button21->FlatAppearance->BorderSize = 0;
			this->button21->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button21->Location = System::Drawing::Point(542, 277);
			this->button21->Name = L"button21";
			this->button21->Size = System::Drawing::Size(130, 130);
			this->button21->TabIndex = 20;
			this->button21->UseVisualStyleBackColor = false;
			this->button21->Click += gcnew System::EventHandler(this, &Form1::button21_Click);
			// 
			// button25
			// 
			this->button25->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button25->FlatAppearance->BorderSize = 0;
			this->button25->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button25->Location = System::Drawing::Point(22, 407);
			this->button25->Name = L"button25";
			this->button25->Size = System::Drawing::Size(130, 130);
			this->button25->TabIndex = 24;
			this->button25->UseVisualStyleBackColor = false;
			this->button25->Click += gcnew System::EventHandler(this, &Form1::button25_Click);
			// 
			// button26
			// 
			this->button26->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button26->FlatAppearance->BorderSize = 0;
			this->button26->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button26->Location = System::Drawing::Point(152, 407);
			this->button26->Name = L"button26";
			this->button26->Size = System::Drawing::Size(130, 130);
			this->button26->TabIndex = 25;
			this->button26->UseVisualStyleBackColor = false;
			this->button26->Click += gcnew System::EventHandler(this, &Form1::button26_Click);
			// 
			// button27
			// 
			this->button27->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button27->FlatAppearance->BorderSize = 0;
			this->button27->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button27->Location = System::Drawing::Point(282, 407);
			this->button27->Name = L"button27";
			this->button27->Size = System::Drawing::Size(130, 130);
			this->button27->TabIndex = 26;
			this->button27->UseVisualStyleBackColor = false;
			this->button27->Click += gcnew System::EventHandler(this, &Form1::button27_Click);
			// 
			// button28
			// 
			this->button28->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button28->FlatAppearance->BorderSize = 0;
			this->button28->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button28->Location = System::Drawing::Point(412, 407);
			this->button28->Name = L"button28";
			this->button28->Size = System::Drawing::Size(130, 130);
			this->button28->TabIndex = 27;
			this->button28->UseVisualStyleBackColor = false;
			this->button28->Click += gcnew System::EventHandler(this, &Form1::button28_Click);
			// 
			// button29
			// 
			this->button29->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button29->FlatAppearance->BorderSize = 0;
			this->button29->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button29->Location = System::Drawing::Point(542, 407);
			this->button29->Name = L"button29";
			this->button29->Size = System::Drawing::Size(130, 130);
			this->button29->TabIndex = 28;
			this->button29->UseVisualStyleBackColor = false;
			this->button29->Click += gcnew System::EventHandler(this, &Form1::button29_Click);
			// 
			// button30
			// 
			this->button30->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button30->FlatAppearance->BorderSize = 0;
			this->button30->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button30->Location = System::Drawing::Point(672, 407);
			this->button30->Name = L"button30";
			this->button30->Size = System::Drawing::Size(130, 130);
			this->button30->TabIndex = 29;
			this->button30->UseVisualStyleBackColor = false;
			this->button30->Click += gcnew System::EventHandler(this, &Form1::button30_Click);
			// 
			// button31
			// 
			this->button31->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button31->FlatAppearance->BorderSize = 0;
			this->button31->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button31->Location = System::Drawing::Point(802, 407);
			this->button31->Name = L"button31";
			this->button31->Size = System::Drawing::Size(130, 130);
			this->button31->TabIndex = 30;
			this->button31->UseVisualStyleBackColor = false;
			this->button31->Click += gcnew System::EventHandler(this, &Form1::button31_Click);
			// 
			// button32
			// 
			this->button32->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button32->FlatAppearance->BorderSize = 0;
			this->button32->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button32->Location = System::Drawing::Point(932, 407);
			this->button32->Name = L"button32";
			this->button32->Size = System::Drawing::Size(130, 130);
			this->button32->TabIndex = 31;
			this->button32->UseVisualStyleBackColor = false;
			this->button32->Click += gcnew System::EventHandler(this, &Form1::button32_Click);
			// 
			// button48
			// 
			this->button48->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button48->FlatAppearance->BorderSize = 0;
			this->button48->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button48->Location = System::Drawing::Point(932, 667);
			this->button48->Name = L"button48";
			this->button48->Size = System::Drawing::Size(130, 130);
			this->button48->TabIndex = 47;
			this->button48->UseVisualStyleBackColor = false;
			this->button48->Click += gcnew System::EventHandler(this, &Form1::button48_Click);
			// 
			// button47
			// 
			this->button47->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button47->FlatAppearance->BorderSize = 0;
			this->button47->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button47->Location = System::Drawing::Point(802, 667);
			this->button47->Name = L"button47";
			this->button47->Size = System::Drawing::Size(130, 130);
			this->button47->TabIndex = 46;
			this->button47->UseVisualStyleBackColor = false;
			this->button47->Click += gcnew System::EventHandler(this, &Form1::button47_Click);
			// 
			// button46
			// 
			this->button46->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button46->FlatAppearance->BorderSize = 0;
			this->button46->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button46->Location = System::Drawing::Point(672, 667);
			this->button46->Name = L"button46";
			this->button46->Size = System::Drawing::Size(130, 130);
			this->button46->TabIndex = 45;
			this->button46->UseVisualStyleBackColor = false;
			this->button46->Click += gcnew System::EventHandler(this, &Form1::button46_Click);
			// 
			// button45
			// 
			this->button45->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button45->FlatAppearance->BorderSize = 0;
			this->button45->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button45->Location = System::Drawing::Point(542, 667);
			this->button45->Name = L"button45";
			this->button45->Size = System::Drawing::Size(130, 130);
			this->button45->TabIndex = 44;
			this->button45->UseVisualStyleBackColor = false;
			this->button45->Click += gcnew System::EventHandler(this, &Form1::button45_Click);
			// 
			// button44
			// 
			this->button44->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button44->FlatAppearance->BorderSize = 0;
			this->button44->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button44->Location = System::Drawing::Point(412, 667);
			this->button44->Name = L"button44";
			this->button44->Size = System::Drawing::Size(130, 130);
			this->button44->TabIndex = 43;
			this->button44->UseVisualStyleBackColor = false;
			this->button44->Click += gcnew System::EventHandler(this, &Form1::button44_Click);
			// 
			// button43
			// 
			this->button43->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button43->FlatAppearance->BorderSize = 0;
			this->button43->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button43->Location = System::Drawing::Point(282, 667);
			this->button43->Name = L"button43";
			this->button43->Size = System::Drawing::Size(130, 130);
			this->button43->TabIndex = 42;
			this->button43->UseVisualStyleBackColor = false;
			this->button43->Click += gcnew System::EventHandler(this, &Form1::button43_Click);
			// 
			// button42
			// 
			this->button42->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button42->FlatAppearance->BorderSize = 0;
			this->button42->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button42->Location = System::Drawing::Point(152, 667);
			this->button42->Name = L"button42";
			this->button42->Size = System::Drawing::Size(130, 130);
			this->button42->TabIndex = 41;
			this->button42->UseVisualStyleBackColor = false;
			this->button42->Click += gcnew System::EventHandler(this, &Form1::button42_Click);
			// 
			// button41
			// 
			this->button41->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button41->FlatAppearance->BorderSize = 0;
			this->button41->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button41->Location = System::Drawing::Point(22, 667);
			this->button41->Name = L"button41";
			this->button41->Size = System::Drawing::Size(130, 130);
			this->button41->TabIndex = 40;
			this->button41->UseVisualStyleBackColor = false;
			this->button41->Click += gcnew System::EventHandler(this, &Form1::button41_Click);
			// 
			// button40
			// 
			this->button40->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button40->FlatAppearance->BorderSize = 0;
			this->button40->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button40->Location = System::Drawing::Point(932, 537);
			this->button40->Name = L"button40";
			this->button40->Size = System::Drawing::Size(130, 130);
			this->button40->TabIndex = 39;
			this->button40->UseVisualStyleBackColor = false;
			this->button40->Click += gcnew System::EventHandler(this, &Form1::button40_Click);
			// 
			// button39
			// 
			this->button39->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button39->FlatAppearance->BorderSize = 0;
			this->button39->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button39->Location = System::Drawing::Point(802, 537);
			this->button39->Name = L"button39";
			this->button39->Size = System::Drawing::Size(130, 130);
			this->button39->TabIndex = 38;
			this->button39->UseVisualStyleBackColor = false;
			this->button39->Click += gcnew System::EventHandler(this, &Form1::button39_Click);
			// 
			// button38
			// 
			this->button38->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button38->FlatAppearance->BorderSize = 0;
			this->button38->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button38->Location = System::Drawing::Point(672, 537);
			this->button38->Name = L"button38";
			this->button38->Size = System::Drawing::Size(130, 130);
			this->button38->TabIndex = 37;
			this->button38->UseVisualStyleBackColor = false;
			this->button38->Click += gcnew System::EventHandler(this, &Form1::button38_Click);
			// 
			// button37
			// 
			this->button37->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button37->FlatAppearance->BorderSize = 0;
			this->button37->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button37->Location = System::Drawing::Point(542, 537);
			this->button37->Name = L"button37";
			this->button37->Size = System::Drawing::Size(130, 130);
			this->button37->TabIndex = 36;
			this->button37->UseVisualStyleBackColor = false;
			this->button37->Click += gcnew System::EventHandler(this, &Form1::button37_Click);
			// 
			// button36
			// 
			this->button36->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button36->FlatAppearance->BorderSize = 0;
			this->button36->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button36->Location = System::Drawing::Point(412, 537);
			this->button36->Name = L"button36";
			this->button36->Size = System::Drawing::Size(130, 130);
			this->button36->TabIndex = 35;
			this->button36->UseVisualStyleBackColor = false;
			this->button36->Click += gcnew System::EventHandler(this, &Form1::button36_Click);
			// 
			// button35
			// 
			this->button35->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button35->FlatAppearance->BorderSize = 0;
			this->button35->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button35->Location = System::Drawing::Point(282, 537);
			this->button35->Name = L"button35";
			this->button35->Size = System::Drawing::Size(130, 130);
			this->button35->TabIndex = 34;
			this->button35->UseVisualStyleBackColor = false;
			this->button35->Click += gcnew System::EventHandler(this, &Form1::button35_Click);
			// 
			// button34
			// 
			this->button34->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button34->FlatAppearance->BorderSize = 0;
			this->button34->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button34->Location = System::Drawing::Point(152, 537);
			this->button34->Name = L"button34";
			this->button34->Size = System::Drawing::Size(130, 130);
			this->button34->TabIndex = 33;
			this->button34->UseVisualStyleBackColor = false;
			this->button34->Click += gcnew System::EventHandler(this, &Form1::button34_Click);
			// 
			// button33
			// 
			this->button33->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button33->FlatAppearance->BorderSize = 0;
			this->button33->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button33->Location = System::Drawing::Point(22, 537);
			this->button33->Name = L"button33";
			this->button33->Size = System::Drawing::Size(130, 130);
			this->button33->TabIndex = 32;
			this->button33->UseVisualStyleBackColor = false;
			this->button33->Click += gcnew System::EventHandler(this, &Form1::button33_Click);
			// 
			// button49
			// 
			this->button49->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button49->FlatAppearance->BorderSize = 0;
			this->button49->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button49->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button49.Image")));
			this->button49->Location = System::Drawing::Point(22, 797);
			this->button49->Name = L"button49";
			this->button49->Size = System::Drawing::Size(130, 130);
			this->button49->TabIndex = 48;
			this->button49->UseVisualStyleBackColor = false;
			this->button49->Click += gcnew System::EventHandler(this, &Form1::button49_Click);
			// 
			// button50
			// 
			this->button50->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button50->FlatAppearance->BorderSize = 0;
			this->button50->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button50->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button50.Image")));
			this->button50->Location = System::Drawing::Point(152, 797);
			this->button50->Name = L"button50";
			this->button50->Size = System::Drawing::Size(130, 130);
			this->button50->TabIndex = 49;
			this->button50->UseVisualStyleBackColor = false;
			this->button50->Click += gcnew System::EventHandler(this, &Form1::button50_Click);
			// 
			// button52
			// 
			this->button52->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button52->FlatAppearance->BorderSize = 0;
			this->button52->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button52->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button52.Image")));
			this->button52->Location = System::Drawing::Point(412, 797);
			this->button52->Name = L"button52";
			this->button52->Size = System::Drawing::Size(130, 130);
			this->button52->TabIndex = 51;
			this->button52->UseVisualStyleBackColor = false;
			this->button52->Click += gcnew System::EventHandler(this, &Form1::button52_Click);
			// 
			// button51
			// 
			this->button51->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button51->FlatAppearance->BorderSize = 0;
			this->button51->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button51->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button51.Image")));
			this->button51->Location = System::Drawing::Point(282, 797);
			this->button51->Name = L"button51";
			this->button51->Size = System::Drawing::Size(130, 130);
			this->button51->TabIndex = 50;
			this->button51->UseVisualStyleBackColor = false;
			this->button51->Click += gcnew System::EventHandler(this, &Form1::button51_Click);
			// 
			// button56
			// 
			this->button56->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button56->FlatAppearance->BorderSize = 0;
			this->button56->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button56->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button56.Image")));
			this->button56->Location = System::Drawing::Point(932, 797);
			this->button56->Name = L"button56";
			this->button56->Size = System::Drawing::Size(130, 130);
			this->button56->TabIndex = 55;
			this->button56->UseVisualStyleBackColor = false;
			this->button56->Click += gcnew System::EventHandler(this, &Form1::button56_Click);
			// 
			// button55
			// 
			this->button55->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button55->FlatAppearance->BorderSize = 0;
			this->button55->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button55->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button55.Image")));
			this->button55->Location = System::Drawing::Point(802, 797);
			this->button55->Name = L"button55";
			this->button55->Size = System::Drawing::Size(130, 130);
			this->button55->TabIndex = 54;
			this->button55->UseVisualStyleBackColor = false;
			this->button55->Click += gcnew System::EventHandler(this, &Form1::button55_Click);
			// 
			// button54
			// 
			this->button54->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button54->FlatAppearance->BorderSize = 0;
			this->button54->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button54->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button54.Image")));
			this->button54->Location = System::Drawing::Point(672, 797);
			this->button54->Name = L"button54";
			this->button54->Size = System::Drawing::Size(130, 130);
			this->button54->TabIndex = 53;
			this->button54->UseVisualStyleBackColor = false;
			this->button54->Click += gcnew System::EventHandler(this, &Form1::button54_Click);
			// 
			// button53
			// 
			this->button53->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button53->FlatAppearance->BorderSize = 0;
			this->button53->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button53->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button53.Image")));
			this->button53->Location = System::Drawing::Point(542, 797);
			this->button53->Name = L"button53";
			this->button53->Size = System::Drawing::Size(130, 130);
			this->button53->TabIndex = 52;
			this->button53->UseVisualStyleBackColor = false;
			this->button53->Click += gcnew System::EventHandler(this, &Form1::button53_Click);
			// 
			// button57
			// 
			this->button57->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button57->FlatAppearance->BorderSize = 0;
			this->button57->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button57->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button57.Image")));
			this->button57->Location = System::Drawing::Point(22, 927);
			this->button57->Name = L"button57";
			this->button57->Size = System::Drawing::Size(130, 130);
			this->button57->TabIndex = 56;
			this->button57->UseVisualStyleBackColor = false;
			this->button57->Click += gcnew System::EventHandler(this, &Form1::button57_Click);
			// 
			// button58
			// 
			this->button58->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button58->FlatAppearance->BorderSize = 0;
			this->button58->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button58->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button58.Image")));
			this->button58->Location = System::Drawing::Point(152, 927);
			this->button58->Name = L"button58";
			this->button58->Size = System::Drawing::Size(130, 130);
			this->button58->TabIndex = 57;
			this->button58->UseVisualStyleBackColor = false;
			this->button58->Click += gcnew System::EventHandler(this, &Form1::button58_Click);
			// 
			// button59
			// 
			this->button59->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button59->FlatAppearance->BorderSize = 0;
			this->button59->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button59->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button59.Image")));
			this->button59->Location = System::Drawing::Point(282, 927);
			this->button59->Name = L"button59";
			this->button59->Size = System::Drawing::Size(130, 130);
			this->button59->TabIndex = 58;
			this->button59->UseVisualStyleBackColor = false;
			this->button59->Click += gcnew System::EventHandler(this, &Form1::button59_Click);
			// 
			// button60
			// 
			this->button60->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button60->FlatAppearance->BorderSize = 0;
			this->button60->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button60->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button60.Image")));
			this->button60->Location = System::Drawing::Point(412, 927);
			this->button60->Name = L"button60";
			this->button60->Size = System::Drawing::Size(130, 130);
			this->button60->TabIndex = 59;
			this->button60->UseVisualStyleBackColor = false;
			this->button60->Click += gcnew System::EventHandler(this, &Form1::button60_Click);
			// 
			// button61
			// 
			this->button61->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button61->FlatAppearance->BorderSize = 0;
			this->button61->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button61->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button61.Image")));
			this->button61->Location = System::Drawing::Point(542, 927);
			this->button61->Name = L"button61";
			this->button61->Size = System::Drawing::Size(130, 130);
			this->button61->TabIndex = 60;
			this->button61->UseVisualStyleBackColor = false;
			this->button61->Click += gcnew System::EventHandler(this, &Form1::button61_Click);
			// 
			// button62
			// 
			this->button62->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button62->FlatAppearance->BorderSize = 0;
			this->button62->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button62->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button62.Image")));
			this->button62->Location = System::Drawing::Point(672, 927);
			this->button62->Name = L"button62";
			this->button62->Size = System::Drawing::Size(130, 130);
			this->button62->TabIndex = 61;
			this->button62->UseVisualStyleBackColor = false;
			this->button62->Click += gcnew System::EventHandler(this, &Form1::button62_Click);
			// 
			// button63
			// 
			this->button63->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button63->FlatAppearance->BorderSize = 0;
			this->button63->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button63->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button63.Image")));
			this->button63->Location = System::Drawing::Point(802, 927);
			this->button63->Name = L"button63";
			this->button63->Size = System::Drawing::Size(130, 130);
			this->button63->TabIndex = 62;
			this->button63->UseVisualStyleBackColor = false;
			this->button63->Click += gcnew System::EventHandler(this, &Form1::button63_Click);
			// 
			// button64
			// 
			this->button64->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
				static_cast<System::Int32>(static_cast<System::Byte>(181)));
			this->button64->FlatAppearance->BorderSize = 0;
			this->button64->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button64->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button64.Image")));
			this->button64->Location = System::Drawing::Point(932, 927);
			this->button64->Name = L"button64";
			this->button64->Size = System::Drawing::Size(130, 130);
			this->button64->TabIndex = 63;
			this->button64->UseVisualStyleBackColor = false;
			this->button64->Click += gcnew System::EventHandler(this, &Form1::button64_Click);
			// 
			// button65
			// 
			this->button65->Font = (gcnew System::Drawing::Font(L"新細明體", 18, System::Drawing::FontStyle::Regular, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->button65->Location = System::Drawing::Point(1717, 957);
			this->button65->Name = L"button65";
			this->button65->Size = System::Drawing::Size(202, 101);
			this->button65->TabIndex = 64;
			this->button65->Text = L"離開遊戲";
			this->button65->UseVisualStyleBackColor = true;
			this->button65->Click += gcnew System::EventHandler(this, &Form1::button65_Click);
			// 
			// groupBox1
			// 
			this->groupBox1->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(100)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->groupBox1->Controls->Add(this->button56);
			this->groupBox1->Controls->Add(this->button55);
			this->groupBox1->Controls->Add(this->button64);
			this->groupBox1->Controls->Add(this->button54);
			this->groupBox1->Controls->Add(this->button63);
			this->groupBox1->Controls->Add(this->button53);
			this->groupBox1->Controls->Add(this->button62);
			this->groupBox1->Controls->Add(this->button52);
			this->groupBox1->Controls->Add(this->button61);
			this->groupBox1->Controls->Add(this->button60);
			this->groupBox1->Controls->Add(this->button51);
			this->groupBox1->Controls->Add(this->button59);
			this->groupBox1->Controls->Add(this->button50);
			this->groupBox1->Controls->Add(this->button58);
			this->groupBox1->Controls->Add(this->button49);
			this->groupBox1->Controls->Add(this->button57);
			this->groupBox1->Controls->Add(this->button48);
			this->groupBox1->Controls->Add(this->button47);
			this->groupBox1->Controls->Add(this->button46);
			this->groupBox1->Controls->Add(this->button45);
			this->groupBox1->Controls->Add(this->button44);
			this->groupBox1->Controls->Add(this->button43);
			this->groupBox1->Controls->Add(this->button42);
			this->groupBox1->Controls->Add(this->button41);
			this->groupBox1->Controls->Add(this->button40);
			this->groupBox1->Controls->Add(this->button39);
			this->groupBox1->Controls->Add(this->button38);
			this->groupBox1->Controls->Add(this->button37);
			this->groupBox1->Controls->Add(this->button36);
			this->groupBox1->Controls->Add(this->button35);
			this->groupBox1->Controls->Add(this->button34);
			this->groupBox1->Controls->Add(this->button33);
			this->groupBox1->Controls->Add(this->button32);
			this->groupBox1->Controls->Add(this->button25);
			this->groupBox1->Controls->Add(this->button26);
			this->groupBox1->Controls->Add(this->button27);
			this->groupBox1->Controls->Add(this->button28);
			this->groupBox1->Controls->Add(this->button29);
			this->groupBox1->Controls->Add(this->button30);
			this->groupBox1->Controls->Add(this->button31);
			this->groupBox1->Controls->Add(this->button24);
			this->groupBox1->Controls->Add(this->button23);
			this->groupBox1->Controls->Add(this->button22);
			this->groupBox1->Controls->Add(this->button21);
			this->groupBox1->Controls->Add(this->button20);
			this->groupBox1->Controls->Add(this->button19);
			this->groupBox1->Controls->Add(this->button18);
			this->groupBox1->Controls->Add(this->button17);
			this->groupBox1->Controls->Add(this->button16);
			this->groupBox1->Controls->Add(this->button15);
			this->groupBox1->Controls->Add(this->button14);
			this->groupBox1->Controls->Add(this->button13);
			this->groupBox1->Controls->Add(this->button12);
			this->groupBox1->Controls->Add(this->button11);
			this->groupBox1->Controls->Add(this->button10);
			this->groupBox1->Controls->Add(this->button9);
			this->groupBox1->Controls->Add(this->button8);
			this->groupBox1->Controls->Add(this->button7);
			this->groupBox1->Controls->Add(this->button6);
			this->groupBox1->Controls->Add(this->button5);
			this->groupBox1->Controls->Add(this->button4);
			this->groupBox1->Controls->Add(this->button3);
			this->groupBox1->Controls->Add(this->button2);
			this->groupBox1->Controls->Add(this->button1);
			this->groupBox1->Location = System::Drawing::Point(71, 1);
			this->groupBox1->Name = L"groupBox1";
			this->groupBox1->Size = System::Drawing::Size(1086, 1084);
			this->groupBox1->TabIndex = 65;
			this->groupBox1->TabStop = false;
			this->groupBox1->Text = L".";
			this->groupBox1->Enter += gcnew System::EventHandler(this, &Form1::groupBox1_Enter);
			// 
			// label1
			// 
			this->label1->AutoSize = true;
			this->label1->BorderStyle = System::Windows::Forms::BorderStyle::FixedSingle;
			this->label1->Font = (gcnew System::Drawing::Font(L"新細明體", 48, System::Drawing::FontStyle::Regular, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->label1->Location = System::Drawing::Point(1179, 148);
			this->label1->Name = L"label1";
			this->label1->Size = System::Drawing::Size(213, 82);
			this->label1->TabIndex = 66;
			this->label1->Text = L"60 : 0";
			this->label1->Click += gcnew System::EventHandler(this, &Form1::label1_Click);
			// 
			// label2
			// 
			this->label2->AutoSize = true;
			this->label2->BorderStyle = System::Windows::Forms::BorderStyle::FixedSingle;
			this->label2->Font = (gcnew System::Drawing::Font(L"新細明體", 48, System::Drawing::FontStyle::Regular, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->label2->Location = System::Drawing::Point(1179, 846);
			this->label2->Name = L"label2";
			this->label2->Size = System::Drawing::Size(213, 82);
			this->label2->TabIndex = 67;
			this->label2->Text = L"60 : 0";
			this->label2->Click += gcnew System::EventHandler(this, &Form1::label2_Click);
			// 
			// label3
			// 
			this->label3->AutoSize = true;
			this->label3->Font = (gcnew System::Drawing::Font(L"微軟正黑體", 28.2F, System::Drawing::FontStyle::Regular, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->label3->Location = System::Drawing::Point(23, 58);
			this->label3->Name = L"label3";
			this->label3->Size = System::Drawing::Size(123, 61);
			this->label3->TabIndex = 68;
			this->label3->Text = L"黑方";
			// 
			// label4
			// 
			this->label4->AutoSize = true;
			this->label4->Font = (gcnew System::Drawing::Font(L"微軟正黑體", 28.2F, System::Drawing::FontStyle::Regular, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->label4->Location = System::Drawing::Point(161, 58);
			this->label4->Name = L"label4";
			this->label4->Size = System::Drawing::Size(123, 61);
			this->label4->TabIndex = 69;
			this->label4->Text = L"白方";
			// 
			// label5
			// 
			this->label5->AutoSize = true;
			this->label5->Font = (gcnew System::Drawing::Font(L"新細明體", 28.2F, System::Drawing::FontStyle::Regular, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->label5->Location = System::Drawing::Point(46, 140);
			this->label5->Name = L"label5";
			this->label5->Size = System::Drawing::Size(67, 48);
			this->label5->TabIndex = 70;
			this->label5->Text = L" 0 ";
			// 
			// label6
			// 
			this->label6->AutoSize = true;
			this->label6->Font = (gcnew System::Drawing::Font(L"新細明體", 28.2F, System::Drawing::FontStyle::Regular, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->label6->Location = System::Drawing::Point(208, 140);
			this->label6->Name = L"label6";
			this->label6->Size = System::Drawing::Size(43, 48);
			this->label6->TabIndex = 71;
			this->label6->Text = L"0";
			this->label6->Click += gcnew System::EventHandler(this, &Form1::label6_Click);
			// 
			// groupBox2
			// 
			this->groupBox2->AutoSize = true;
			this->groupBox2->BackColor = System::Drawing::Color::AntiqueWhite;
			this->groupBox2->Controls->Add(this->label6);
			this->groupBox2->Controls->Add(this->label5);
			this->groupBox2->Controls->Add(this->label4);
			this->groupBox2->Controls->Add(this->label3);
			this->groupBox2->Font = (gcnew System::Drawing::Font(L"微軟正黑體", 18, System::Drawing::FontStyle::Bold, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->groupBox2->ForeColor = System::Drawing::Color::Black;
			this->groupBox2->Location = System::Drawing::Point(1179, 469);
			this->groupBox2->Name = L"groupBox2";
			this->groupBox2->Size = System::Drawing::Size(295, 231);
			this->groupBox2->TabIndex = 72;
			this->groupBox2->TabStop = false;
			this->groupBox2->Text = L"計分表";
			// 
			// button66
			// 
			this->button66->BackColor = System::Drawing::Color::Red;
			this->button66->Font = (gcnew System::Drawing::Font(L"新細明體", 22.2F, System::Drawing::FontStyle::Bold, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->button66->ForeColor = System::Drawing::SystemColors::ButtonHighlight;
			this->button66->Location = System::Drawing::Point(1747, 798);
			this->button66->Name = L"button66";
			this->button66->Size = System::Drawing::Size(172, 130);
			this->button66->TabIndex = 73;
			this->button66->Text = L"投降";
			this->button66->UseVisualStyleBackColor = false;
			this->button66->Click += gcnew System::EventHandler(this, &Form1::button66_Click);
			// 
			// pictureBox1
			// 
			this->pictureBox1->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"pictureBox1.Image")));
			this->pictureBox1->Location = System::Drawing::Point(1179, 2);
			this->pictureBox1->Name = L"pictureBox1";
			this->pictureBox1->Size = System::Drawing::Size(103, 103);
			this->pictureBox1->SizeMode = System::Windows::Forms::PictureBoxSizeMode::AutoSize;
			this->pictureBox1->TabIndex = 74;
			this->pictureBox1->TabStop = false;
			this->pictureBox1->Click += gcnew System::EventHandler(this, &Form1::pictureBox1_Click);
			// 
			// button67
			// 
			this->button67->BackColor = System::Drawing::SystemColors::ButtonFace;
			this->button67->FlatAppearance->BorderSize = 0;
			this->button67->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button67->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button67.Image")));
			this->button67->Location = System::Drawing::Point(1544, 501);
			this->button67->Name = L"button67";
			this->button67->Size = System::Drawing::Size(179, 167);
			this->button67->TabIndex = 76;
			this->button67->UseVisualStyleBackColor = false;
			// 
			// button68
			// 
			this->button68->BackColor = System::Drawing::SystemColors::Control;
			this->button68->FlatAppearance->BorderSize = 0;
			this->button68->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button68->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button68.Image")));
			this->button68->Location = System::Drawing::Point(1750, 501);
			this->button68->Name = L"button68";
			this->button68->Size = System::Drawing::Size(180, 167);
			this->button68->TabIndex = 77;
			this->button68->UseVisualStyleBackColor = false;
			// 
			// button69
			// 
			this->button69->BackColor = System::Drawing::Color::LightGray;
			this->button69->Font = (gcnew System::Drawing::Font(L"微軟正黑體", 25.8F, System::Drawing::FontStyle::Bold, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->button69->Location = System::Drawing::Point(1600, 18);
			this->button69->Name = L"button69";
			this->button69->Size = System::Drawing::Size(162, 234);
			this->button69->TabIndex = 78;
			this->button69->Text = L"存檔";
			this->button69->UseVisualStyleBackColor = false;
			// 
			// button70
			// 
			this->button70->BackColor = System::Drawing::Color::LightGray;
			this->button70->Font = (gcnew System::Drawing::Font(L"微軟正黑體", 25.8F, System::Drawing::FontStyle::Bold, System::Drawing::GraphicsUnit::Point,
				static_cast<System::Byte>(136)));
			this->button70->Location = System::Drawing::Point(1768, 18);
			this->button70->Name = L"button70";
			this->button70->Size = System::Drawing::Size(162, 234);
			this->button70->TabIndex = 79;
			this->button70->Text = L"讀檔";
			this->button70->UseVisualStyleBackColor = false;
			// 
			// pictureBox3
			// 
			this->pictureBox3->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"pictureBox3.Image")));
			this->pictureBox3->Location = System::Drawing::Point(1179, 942);
			this->pictureBox3->Name = L"pictureBox3";
			this->pictureBox3->Size = System::Drawing::Size(103, 103);
			this->pictureBox3->SizeMode = System::Windows::Forms::PictureBoxSizeMode::AutoSize;
			this->pictureBox3->TabIndex = 80;
			this->pictureBox3->TabStop = false;
			// 
			// button71
			// 
			this->button71->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button71->FlatAppearance->BorderSize = 0;
			this->button71->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button71->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button71.Image")));
			this->button71->Location = System::Drawing::Point(1195, 307);
			this->button71->Name = L"button71";
			this->button71->Size = System::Drawing::Size(130, 130);
			this->button71->TabIndex = 81;
			this->button71->UseVisualStyleBackColor = false;
			this->button71->Visible = false;
			this->button71->Click += gcnew System::EventHandler(this, &Form1::button71_Click);
			// 
			// button72
			// 
			this->button72->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button72->FlatAppearance->BorderSize = 0;
			this->button72->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button72->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button72.Image")));
			this->button72->Location = System::Drawing::Point(1347, 307);
			this->button72->Name = L"button72";
			this->button72->Size = System::Drawing::Size(130, 130);
			this->button72->TabIndex = 82;
			this->button72->UseVisualStyleBackColor = false;
			this->button72->Visible = false;
			this->button72->Click += gcnew System::EventHandler(this, &Form1::button72_Click);
			// 
			// button73
			// 
			this->button73->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button73->FlatAppearance->BorderSize = 0;
			this->button73->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button73->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button73.Image")));
			this->button73->Location = System::Drawing::Point(1499, 307);
			this->button73->Name = L"button73";
			this->button73->Size = System::Drawing::Size(130, 130);
			this->button73->TabIndex = 83;
			this->button73->UseVisualStyleBackColor = false;
			this->button73->Visible = false;
			this->button73->Click += gcnew System::EventHandler(this, &Form1::button73_Click);
			// 
			// button74
			// 
			this->button74->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
				static_cast<System::Int32>(static_cast<System::Byte>(0)));
			this->button74->FlatAppearance->BorderSize = 0;
			this->button74->FlatStyle = System::Windows::Forms::FlatStyle::Flat;
			this->button74->Image = (cli::safe_cast<System::Drawing::Image^>(resources->GetObject(L"button74.Image")));
			this->button74->Location = System::Drawing::Point(1651, 307);
			this->button74->Name = L"button74";
			this->button74->Size = System::Drawing::Size(130, 130);
			this->button74->TabIndex = 84;
			this->button74->UseVisualStyleBackColor = false;
			this->button74->Visible = false;
			this->button74->Click += gcnew System::EventHandler(this, &Form1::button74_Click);
			// 
			// timer1
			// 
			this->timer1->Interval = 1000;
			this->timer1->Tick += gcnew System::EventHandler(this, &Form1::timer1_Tick);
			// 
			// timer2
			// 
			this->timer2->Interval = 1000;
			this->timer2->Tick += gcnew System::EventHandler(this, &Form1::timer2_Tick);
			// 
			// Form1
			// 
			this->AutoScaleDimensions = System::Drawing::SizeF(8, 15);
			this->AutoScaleMode = System::Windows::Forms::AutoScaleMode::Font;
			this->BackColor = System::Drawing::SystemColors::Control;
			this->ClientSize = System::Drawing::Size(1942, 1102);
			this->Controls->Add(this->button74);
			this->Controls->Add(this->button73);
			this->Controls->Add(this->button72);
			this->Controls->Add(this->button71);
			this->Controls->Add(this->pictureBox3);
			this->Controls->Add(this->button70);
			this->Controls->Add(this->button69);
			this->Controls->Add(this->button68);
			this->Controls->Add(this->button67);
			this->Controls->Add(this->pictureBox1);
			this->Controls->Add(this->button66);
			this->Controls->Add(this->groupBox2);
			this->Controls->Add(this->label2);
			this->Controls->Add(this->label1);
			this->Controls->Add(this->groupBox1);
			this->Controls->Add(this->button65);
			this->FormBorderStyle = System::Windows::Forms::FormBorderStyle::None;
			this->Name = L"Form1";
			this->StartPosition = System::Windows::Forms::FormStartPosition::CenterScreen;
			this->WindowState = System::Windows::Forms::FormWindowState::Maximized;
			this->Load += gcnew System::EventHandler(this, &Form1::Form1_Load);
			this->groupBox1->ResumeLayout(false);
			this->groupBox2->ResumeLayout(false);
			this->groupBox2->PerformLayout();
			(cli::safe_cast<System::ComponentModel::ISupportInitialize^>(this->pictureBox1))->EndInit();
			(cli::safe_cast<System::ComponentModel::ISupportInitialize^>(this->pictureBox3))->EndInit();
			this->ResumeLayout(false);
			this->PerformLayout();

		}
#pragma endregion

	private: System::Void Form1_Load(System::Object^ sender, System::EventArgs^ e) {	//第一次載入時觸發
		if (MessageBox::Show("DO YOU WANT TO PLAY A GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
		{
		
			MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);

			////  CLR 版本寫入
			//StreamWriter^ outFile = gcnew StreamWriter(".\\GameLog.txt", true);
			//String^ text = "123 456";
			//outFile->WriteLine(text);
			//outFile->Close();
			//StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
			//text = inFile->ReadLine();
			//for (int i = 0; i < text->Length&&text[i] != ' '; i++)
			//{
			//	int a = 5;
			//}
			////  CLR 版本讀出
			//StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);
			//text = inFile->ReadLine();
			//a = text[0] - '0';
			//int a;
			//inFile->Close();
			Application::Exit();
		}
		else
		{
			MessageBox::Show("START !!", "歡迎光臨", MessageBoxButtons::OK);
			if (MessageBox::Show("你想要白方先攻嗎?", "先攻後攻詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
			{	
				//啟用白方計時器
				timer1->Start();
			}
			else
			{
				whoFirst = "Black";
				gm.changePlayer();
				//啟用黑方計時器
				timer2->Start();
			}
		}
	}


	private:
		void printViewer(Viewer* v)
		{
			System::ComponentModel::ComponentResourceManager^ resources = (gcnew System::ComponentModel::ComponentResourceManager(Form1::typeid));
			/* 處理版面 */
			array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
										button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
										button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
										button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
										button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
										button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
										button61,  button62,  button63,  button64 };
			for (int i = 0; i < 8; i++)
			{
				for (int j = 0; j < 8; j++)
				{
					if (!((i % 2 == 1 && j % 2 == 0) || (i % 2 == 0 && j % 2 == 1)))
					{
						buttonArray[i * 8 + j]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(218)),
							static_cast<System::Int32>(static_cast<System::Byte>(181)));		//淺木
					}
					else if ((i % 2 == 1 && j % 2 == 0) || (i % 2 == 0 && j % 2 == 1))
					{
						buttonArray[i * 8 + j]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(149)), static_cast<System::Int32>(static_cast<System::Byte>(74)),
							static_cast<System::Int32>(static_cast<System::Byte>(0)));			//深木
					}
					if (v->getVBoard(i, j) == "SPACE")
					{
						buttonArray[i * 8 + j]->Image = nullptr;		//沒有存在就不能刪除!!!，這是超大問號BUG!!!!!!!!!!!!!!!!!!!
						//如果是移動路徑上就設定為黃色
						if (v->getWay(i, j))
						{
							buttonArray[i * 8 + j]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(148)),
								static_cast<System::Int32>(static_cast<System::Byte>(40)));
						}
						else			//不是的話就恢復本來的顏色
						{

						}
					}
					else
					{
						////看是甚麼顏色，就顯示甚麼顏色
						//if (v->getVBoard(i, j)[0]== 'W')
						//{
						//	buttonArray[i * 8 + j]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(148)),
						//		static_cast<System::Int32>(static_cast<System::Byte>(40)));
						//}
						//else if (vBoard[i][j][0] == 'B')
						//{
						//	SetColor(240);
						//}

						//如果是移動路徑上就設定為黃色
						//if (v->getWay(i, j))
						//{
						//	if (buttonArray[i * 8 + j]->Image != nullptr)
						//	{
						//		buttonArray[i * 8 + j]->Image = nullptr;
						//	}
						//	//卡N個小時的BUG，不能刪沒有image的控制項!!! 應該是delete的問題。
						//	buttonArray[i * 8 + j]->Image = Image::FromFile(".\\RedBird.png");		//表示可走路徑
						//}
						//else if (buttonArray[i * 8 + j]->Image != nullptr)
						//{
						//	buttonArray[i * 8 + j]->Image = nullptr;		//沒有存在就不能刪除!!!，這是超大問號BUG!!!!!!!!!!!!!!!!!!!
						//}
						//如果是移動路徑上就設定為黃色
						if (v->getWay(i, j))
						{
							buttonArray[i * 8 + j]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(148)),
								static_cast<System::Int32>(static_cast<System::Byte>(40)));
						}
						if (v->getVBoard(i, j) == "WKing")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\白國王.png");
						}
						else if (v->getVBoard(i, j) == "WQueen")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\白皇后.png");
						}
						else if (v->getVBoard(i, j) == "WBishop")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\白主教.png");
						}
						else if (v->getVBoard(i, j) == "WRook")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\白城堡.png");
						}
						else if (v->getVBoard(i, j) == "WKnight")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\白馬.png");
						}
						else if (v->getVBoard(i, j) == "WPawn")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\白士兵.png");
						}
						else if (v->getVBoard(i, j) == "BKing")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\黑國王.png");
						}
						else if (v->getVBoard(i, j) == "BQueen")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\黑皇后.png");
						}
						else if (v->getVBoard(i, j) == "BBishop")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\黑主教.png");
						}
						else if (v->getVBoard(i, j) == "BRook")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\黑城堡.png");
						}
						else if (v->getVBoard(i, j) == "BKnight")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\黑馬.png");
						}
						else if (v->getVBoard(i, j) == "BPawn")
						{
							buttonArray[i * 8 + j]->Image = Image::FromFile(".\\黑士兵.png");
						}
					}
				}
			}
			/************/
		}
		int lastX, lastY;

	private: System::Void button1_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button1->TabIndex) % 8;
		y = (this->button1->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button1->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button1->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button2_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button2->TabIndex) % 8;
		y = (this->button2->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button2->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button2->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button3_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button3->TabIndex) % 8;
		y = (this->button3->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button3->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button3->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button4_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button4->TabIndex) % 8;
		y = (this->button4->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button4->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button4->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button5_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button5->TabIndex) % 8;
		y = (this->button5->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button5->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button5->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button6_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button6->TabIndex) % 8;
		y = (this->button6->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button6->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button6->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button7_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button7->TabIndex) % 8;
		y = (this->button7->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button7->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button7->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button8_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button8->TabIndex) % 8;
		y = (this->button8->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button8->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button8->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button9_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button9->TabIndex) % 8;
		y = (this->button9->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button9->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button9->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button10_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button10->TabIndex) % 8;
		y = (this->button10->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button10->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button10->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button11_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button11->TabIndex) % 8;
		y = (this->button11->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button11->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button11->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button12_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button12->TabIndex) % 8;
		y = (this->button12->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button12->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button12->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button13_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button13->TabIndex) % 8;
		y = (this->button13->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button13->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button13->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button14_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button14->TabIndex) % 8;
		y = (this->button14->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button14->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button14->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button15_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button15->TabIndex) % 8;
		y = (this->button15->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button15->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button15->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button16_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button16->TabIndex) % 8;
		y = (this->button16->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button16->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button16->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button17_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button17->TabIndex) % 8;
		y = (this->button17->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button17->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button17->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button18_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button18->TabIndex) % 8;
		y = (this->button18->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button18->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button18->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button19_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button19->TabIndex) % 8;
		y = (this->button19->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button19->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button19->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button20_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button20->TabIndex) % 8;
		y = (this->button20->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button20->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button20->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button21_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button21->TabIndex) % 8;
		y = (this->button21->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button21->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button21->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button22_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button22->TabIndex) % 8;
		y = (this->button22->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button22->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button22->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button23_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button23->TabIndex) % 8;
		y = (this->button23->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button23->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button23->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button24_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button24->TabIndex) % 8;
		y = (this->button24->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button24->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button24->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button25_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button25->TabIndex) % 8;
		y = (this->button25->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button25->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button25->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button26_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button26->TabIndex) % 8;
		y = (this->button26->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button26->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button26->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button27_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button27->TabIndex) % 8;
		y = (this->button27->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button27->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button27->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button28_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button28->TabIndex) % 8;
		y = (this->button28->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button28->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button28->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button29_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button29->TabIndex) % 8;
		y = (this->button29->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button29->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button29->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button30_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button30->TabIndex) % 8;
		y = (this->button30->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button30->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button30->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button31_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button31->TabIndex) % 8;
		y = (this->button31->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button31->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button31->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button32_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button32->TabIndex) % 8;
		y = (this->button32->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button32->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button32->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button33_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button33->TabIndex) % 8;
		y = (this->button33->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button33->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button33->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button34_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button34->TabIndex) % 8;
		y = (this->button34->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button34->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button34->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button35_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button35->TabIndex) % 8;
		y = (this->button35->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button35->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button35->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button36_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button36->TabIndex) % 8;
		y = (this->button36->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button36->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button36->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button37_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button37->TabIndex) % 8;
		y = (this->button37->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button37->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button37->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button38_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button38->TabIndex) % 8;
		y = (this->button38->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button38->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button38->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button39_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button39->TabIndex) % 8;
		y = (this->button39->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button39->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button39->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button40_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button40->TabIndex) % 8;
		y = (this->button40->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button40->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button40->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button41_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button41->TabIndex) % 8;
		y = (this->button41->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button41->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button41->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button42_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button42->TabIndex) % 8;
		y = (this->button42->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button42->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button42->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button43_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button43->TabIndex) % 8;
		y = (this->button43->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button43->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button43->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button44_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button44->TabIndex) % 8;
		y = (this->button44->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button44->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button44->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button45_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button45->TabIndex) % 8;
		y = (this->button45->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button45->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button45->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button46_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button46->TabIndex) % 8;
		y = (this->button46->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button46->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button46->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button47_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button47->TabIndex) % 8;
		y = (this->button47->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button47->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button47->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button48_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button48->TabIndex) % 8;
		y = (this->button48->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button48->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button48->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button49_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button49->TabIndex) % 8;
		y = (this->button49->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button49->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button49->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button50_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button50->TabIndex) % 8;
		y = (this->button50->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button50->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button50->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button51_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button51->TabIndex) % 8;
		y = (this->button51->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button51->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button51->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button52_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button52->TabIndex) % 8;
		y = (this->button52->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button52->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button52->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button53_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button53->TabIndex) % 8;
		y = (this->button53->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button53->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button53->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button54_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button54->TabIndex) % 8;
		y = (this->button54->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button54->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button54->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button55_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button55->TabIndex) % 8;
		y = (this->button55->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button55->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button55->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button56_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button56->TabIndex) % 8;
		y = (this->button56->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button56->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button56->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button57_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button57->TabIndex) % 8;
		y = (this->button57->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button57->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button57->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button58_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button58->TabIndex) % 8;
		y = (this->button58->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button58->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button58->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button59_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button59->TabIndex) % 8;
		y = (this->button59->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button59->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button59->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button60_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button60->TabIndex) % 8;
		y = (this->button60->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button60->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button60->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button61_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button61->TabIndex) % 8;
		y = (this->button61->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button61->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button61->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button62_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button62->TabIndex) % 8;
		y = (this->button62->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button62->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button62->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button63_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button63->TabIndex) % 8;
		y = (this->button63->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button63->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button63->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}
	private: System::Void button64_Click(System::Object^ sender, System::EventArgs^ e) {
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		gameOver = false;
		v->setViewer(*gb);
		int x, y;
		x = (this->button64->TabIndex) % 8;
		y = (this->button64->TabIndex) / 8;
		nowPlaying = gm.getPlayer();
		array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
		if (seq == "move")
		{
			nowPlaying->castling(*gm.getOpponent(), *v, gm.getCurrnet());		//入堡
			nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第一個按
			printViewer(v);
			//將死
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			lastX = x;
			lastY = y;
			seq = "move2";
			lastButtonIndex = this->button64->TabIndex;		//儲存上一步驟
		}
		else if (seq == "move2")
		{
			Position to_pos;
			to_pos.x = x;
			to_pos.y = y;
			nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
			printViewer(v);

			//將軍和將死判斷
			if (nowPlaying->isChecked())
			{
				if (gm.getCurrnet() ^ 1 == 1)
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "WKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}

				}
				else
				{
					for (int i = 0; i < 8; i++)
					{
						for (int j = 0; j < 8; j++)
						{
							if (v->getVBoard(j, i) == "BKing")
							{
								buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
									static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
							}
						}
					}
				}
			}
			//
			if (nowPlaying->getMoved() == true)
			{
				nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
				nowPlaying->resetMoved();
				gm.changePlayer();
				gm.eat();
				/*gm.checkMate(gameOver);*/


				/*********升階判斷***********/
				if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
				{
					/*nowPlaying->OnPromote(*gb, to_pos);*/
					MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		//Invalid Position
					button71->Visible = true;
					button72->Visible = true;
					button73->Visible = true;
					button74->Visible = true;
					upPos = to_pos;
				}

				//if (!(nowPlaying->getMoved()))
				//{
				//	MessageBox::Show("Invalid Position", "錯誤", MessageBoxButtons::OK);		//Invalid Position
				//}
				/************************/

				/*******************寫入********************/

				//  CLR 版本寫入
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				String^ text = lastButtonIndex.ToString() + " " + this->button64->TabIndex.ToString();		//寫入
				inFile->WriteLine(text);
				inFile->Close();		//寫入的關閉

				/*******************************************/

				/*********判斷結束遊戲********/
				gm.checkMate(gameOver);
				if (gameOver)
				{
					if (gm.getCurrnet() == 1)	//現在是黑
					{
						timer1->Stop();	//白
					}
					else if (gm.getCurrnet() == 0)	//現在是白
					{
						timer2->Stop();
					}
					if (gm.getCurrnet() == 0)
					{
						MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}
					else
					{
						MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
					}

					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					lastButtonIndex = -1;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					gameOver = false;
					secondWhite = 3600;
					secondBlack = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);

					/**********************************決定是否要回放*********************************/
						/******讓檔案必定存在*****/
					StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
					inFile->Close();		//寫入的關閉
						/*************************/
					//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
					if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
					{
						if (whoFirst == "Black")
						{
							gm.changePlayer();
							nowPlaying = gm.getPlayer();
						}
						//  I WANT TO REPLAY!!
						//  CLR 版本讀出
						StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
						while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
						{
							int lastIndex = 0, NowIndex = 0;
							int i = 0, j = 0;
							for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
							{
								lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
							}
							i++;
							for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
							{
								NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
							}
							/********** MOVE1 **********/
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							int x, y;
							x = (lastIndex) % 8;
							y = (lastIndex) / 8;
							nowPlaying = gm.getPlayer();
							array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
											button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
											button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
											button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
											button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
											button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
											button61,  button62,  button63,  button64 };
							// MOVE 1
							nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
							printViewer(v);
							//將死
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							lastX = x;
							lastY = y;
							/***********************/

							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

							/******** MOVE2  *******/
							gb = gm.getBoard();
							v = gm.getViewer();
							v->setViewer(*gb);
							nowPlaying = gm.getPlayer();
							x = (NowIndex) % 8;
							y = (NowIndex) / 8;
							Position to_pos;
							to_pos.x = x;
							to_pos.y = y;
							nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
							printViewer(v);
							//將軍和將死判斷
							if (nowPlaying->isChecked())
							{
								if (gm.getCurrnet() ^ 1 == 1)
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "WKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}

								}
								else
								{
									for (int i = 0; i < 8; i++)
									{
										for (int j = 0; j < 8; j++)
										{
											if (v->getVBoard(j, i) == "BKing")
											{
												buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
													static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
											}
										}
									}
								}
							}
							//
							if (nowPlaying->getMoved() == true)
							{
								nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
								nowPlaying->resetMoved();
								gm.changePlayer();
								gm.eat();
								/*********升階判斷***********/
								if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
								{
									/*nowPlaying->OnPromote(*gb, to_pos);*/
									//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
									/*button71->Visible = true;
									button72->Visible = true;
									button73->Visible = true;
									button74->Visible = true;*/
									upPos = to_pos;
									text = inFile->ReadLine();
									int upIndex;
									for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
									{
										upIndex = upIndex * pow(10, i) + (text[i] - '0');
									}
									if (upIndex == 81)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 82)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 83)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									else if (upIndex == 84)
									{
										Board* gb = gm.getBoard();
										Viewer* v = gm.getViewer();
										v->setViewer(*gb);
										gm.changePlayer();		//返回上個對手步
										nowPlaying = gm.getPlayer();
										nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
										v->setViewer(*gb);

										gm.changePlayer();		//返回原來對手步
										printViewer(v);
									}
									upPos = to_pos;
								}
								gm.checkMate(gameOver);
								if (gameOver)
								{
									if (gm.getCurrnet() == 0)
									{
										MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									else
									{
										MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
									}
									/**********初始化************/
									std::string mode = "human";
									GameManager resetGm(mode);
									Position resetUpPos;
									Player* resetNowPlaying;
									lastButtonIndex = -1;
									gm = resetGm;
									upPos = resetUpPos;
									nowPlaying = resetNowPlaying;
									bool gameOver = false;
									secondWhite = 3600;
									secondBlack = 3600;
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
									label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
									printViewer(v);
									/****************************/

								}
								MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
							}
						}

						inFile->Close();			//回放結束，檔案關閉。
						remove(".\\GameLog.txt");
						MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
						gameOver = false;
					}
					/*****************************************************************************************/
					remove(".\\GameLog.txt");

					if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
					{
						MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
						Application::Exit();
					}
					else
					{
						/***************初始化，重新開始新的一局*****************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondWhite = 3600;
						secondBlack = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
					}

					/***********************************************************/

				}
				/**** 關閉一方啟動計時器，啟動另一方計時器。****/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
					timer2->Start();	//白
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{

					timer1->Start();
					timer2->Stop();
				}
				/***********************************************/
				/******************************/
			}
			seq = "move";
		}
	}

	private: System::Void button65_Click(System::Object^ sender, System::EventArgs^ e) {		//離開遊戲
		remove(".\\GameLog.txt");
		Application::Exit();
	}
	private: System::Void groupBox1_Enter(System::Object^ sender, System::EventArgs^ e) {
	}
	private: System::Void label6_Click(System::Object^ sender, System::EventArgs^ e) {
	}
	private: System::Void button67_Click(System::Object^ sender, System::EventArgs^ e) {
	}
	private: System::Void button66_Click(System::Object^ sender, System::EventArgs^ e)
	{
		/******讓檔案必定存在*****/
		StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
		inFile->Close();		//寫入的關閉
		/*************************/
		if (gm.getCurrnet() == 0)	//現在是白
		{
			timer1->Stop();	//白
		}
		else if (gm.getCurrnet() == 1)	//現在是黑
		{
			timer2->Stop();
		}
		if (gm.getCurrnet() == 0)
		{
			MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
		}
		else
		{
			MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
		}

		/***************初始化，重新開始新的一局*****************/
		std::string mode = "human";
		GameManager resetGm(mode);
		Position resetUpPos;
		Player* resetNowPlaying;
		lastButtonIndex = -1;
		gm = resetGm;
		upPos = resetUpPos;
		nowPlaying = resetNowPlaying;
		gameOver = false;
		secondBlack = 3600;
		secondWhite = 3600;
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		v->setViewer(*gb);
		label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
		label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
		printViewer(v);
		/**********************************決定是否要回放*********************************/
		//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
		if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
		{
			if (whoFirst == "Black")
			{
				gm.changePlayer();
				nowPlaying = gm.getPlayer();
			}
			//  I WANT TO REPLAY!!
			//  CLR 版本讀出
			String^ text = "";
			StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
			while (( text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
			{
				int lastIndex = 0, NowIndex = 0;
				int i = 0, j = 0;
				for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
				{
					lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
				}
				i++;
				for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
				{
					NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
				}
				/********** MOVE1 **********/
				Board* gb = gm.getBoard();
				Viewer* v = gm.getViewer();
				v->setViewer(*gb);
				int x, y;
				x = (lastIndex) % 8;
				y = (lastIndex) / 8;
				nowPlaying = gm.getPlayer();
				array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
								button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
								button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
								button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
								button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
								button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
								button61,  button62,  button63,  button64 };
				// MOVE 1
				nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
				printViewer(v);
				//將死
				if (nowPlaying->isChecked())
				{
					if (gm.getCurrnet() ^ 1 == 1)
					{
						for (int i = 0; i < 8; i++)
						{
							for (int j = 0; j < 8; j++)
							{
								if (v->getVBoard(j, i) == "WKing")
								{
									buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
										static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
								}
							}
						}

					}
					else
					{
						for (int i = 0; i < 8; i++)
						{
							for (int j = 0; j < 8; j++)
							{
								if (v->getVBoard(j, i) == "BKing")
								{
									buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
										static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
								}
							}
						}
					}
				}
				lastX = x;
				lastY = y;
				/***********************/

				MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

				/******** MOVE2  *******/
				gb = gm.getBoard();
				v = gm.getViewer();
				v->setViewer(*gb);
				nowPlaying = gm.getPlayer();
				x = (NowIndex) % 8;
				y = (NowIndex) / 8;
				Position to_pos;
				to_pos.x = x;
				to_pos.y = y;
				nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
				printViewer(v);
				//將軍和將死判斷
				if (nowPlaying->isChecked())
				{
					if (gm.getCurrnet() ^ 1 == 1)
					{
						for (int i = 0; i < 8; i++)
						{
							for (int j = 0; j < 8; j++)
							{
								if (v->getVBoard(j, i) == "WKing")
								{
									buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
										static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
								}
							}
						}

					}
					else
					{
						for (int i = 0; i < 8; i++)
						{
							for (int j = 0; j < 8; j++)
							{
								if (v->getVBoard(j, i) == "BKing")
								{
									buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
										static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
								}
							}
						}
					}
				}
				//
				if (nowPlaying->getMoved() == true)
				{
					nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
					nowPlaying->resetMoved();
					gm.changePlayer();
					gm.eat();
					/*********升階判斷***********/
					if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
					{
						/*nowPlaying->OnPromote(*gb, to_pos);*/
						//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
						/*button71->Visible = true;
						button72->Visible = true;
						button73->Visible = true;
						button74->Visible = true;*/
						upPos = to_pos;
						text = inFile->ReadLine();
						int upIndex;
						for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
						{
							upIndex = upIndex * pow(10, i) + (text[i] - '0');
						}
						if (upIndex == 81)
						{
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							gm.changePlayer();		//返回上個對手步
							nowPlaying = gm.getPlayer();
							nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
							v->setViewer(*gb);

							gm.changePlayer();		//返回原來對手步
							printViewer(v);
						}
						else if (upIndex == 82)
						{
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							gm.changePlayer();		//返回上個對手步
							nowPlaying = gm.getPlayer();
							nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
							v->setViewer(*gb);

							gm.changePlayer();		//返回原來對手步
							printViewer(v);
						}
						else if (upIndex == 83)
						{
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							gm.changePlayer();		//返回上個對手步
							nowPlaying = gm.getPlayer();
							nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
							v->setViewer(*gb);

							gm.changePlayer();		//返回原來對手步
							printViewer(v);
						}
						else if (upIndex == 84)
						{
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							gm.changePlayer();		//返回上個對手步
							nowPlaying = gm.getPlayer();
							nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
							v->setViewer(*gb);

							gm.changePlayer();		//返回原來對手步
							printViewer(v);
						}
						upPos = to_pos;
					}
					gm.checkMate(gameOver);
					if (gameOver)
					{
						if (gm.getCurrnet() == 0)
						{
							MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
						}
						else
						{
							MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
						}
						/**********初始化************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						lastButtonIndex = -1;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondBlack = 3600;
						secondWhite = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);

						/****************************/

					}
					MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
				}
			}

			inFile->Close();			//回放結束，檔案關閉。
			remove(".\\GameLog.txt");
			MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
			gameOver = false;
		}
		/*****************************************************************************************/

		remove(".\\GameLog.txt");
		if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
		{
			MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
			Application::Exit();
		}
		else
		{
			/***************初始化，重新開始新的一局*****************/
			std::string mode = "human";
			GameManager resetGm(mode);
			Position resetUpPos;
			Player* resetNowPlaying;
			gm = resetGm;
			upPos = resetUpPos;
			nowPlaying = resetNowPlaying;
			bool gameOver = false;
			secondBlack = 3600;
			secondWhite = 3600;
			Board* gb = gm.getBoard();
			Viewer* v = gm.getViewer();
			v->setViewer(*gb);
			printViewer(v);
			MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
			if (gm.getCurrnet() == 1)	//現在是黑 。
			{
				timer1->Stop();	//黑
				timer2->Start();	//白
			}
			else if (gm.getCurrnet() == 0)	//現在是白
			{

				timer1->Start();
				timer2->Stop();
			}
		}

		/***********************************************************/

	}



	private: System::Void pictureBox1_Click(System::Object^ sender, System::EventArgs^ e) {
	}
	private: System::Void button71_Click(System::Object^ sender, System::EventArgs^ e) {
		//升階------------------------------------------------------------國王
		/*******************寫入********************/

				//  CLR 版本寫入
		StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
		String^ text = this->button71->TabIndex.ToString();		//寫入
		inFile->WriteLine(text);
		inFile->Close();		//寫入的關閉

		/*******************************************/
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		v->setViewer(*gb);
		gm.changePlayer();		//返回上個對手步
		nowPlaying = gm.getPlayer();
		nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
		v->setViewer(*gb);

		gm.changePlayer();		//返回原來對手步
		printViewer(v);
		button71->Visible = false;
		button72->Visible = false;
		button73->Visible = false;
		button74->Visible = false;
	}
	private: System::Void button72_Click(System::Object^ sender, System::EventArgs^ e) {
		//升階------------------------------------------------------------城堡
		/*******************寫入********************/

				//  CLR 版本寫入
		StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
		String^ text = this->button72->TabIndex.ToString();		//寫入
		inFile->WriteLine(text);
		inFile->Close();		//寫入的關閉

		/*******************************************/
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		v->setViewer(*gb);
		gm.changePlayer();		//返回上個對手步
		nowPlaying = gm.getPlayer();
		nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
		v->setViewer(*gb);

		gm.changePlayer();		//返回原來對手步
		printViewer(v);
		button71->Visible = false;
		button72->Visible = false;
		button73->Visible = false;
		button74->Visible = false;
	}
	private: System::Void button73_Click(System::Object^ sender, System::EventArgs^ e) {
		//升階------------------------------------------------------------馬
		/*******************寫入********************/

				//  CLR 版本寫入
		StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
		String^ text = this->button73->TabIndex.ToString();		//寫入
		inFile->WriteLine(text);
		inFile->Close();		//寫入的關閉

		/*******************************************/
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		v->setViewer(*gb);
		gm.changePlayer();		//返回上個對手步
		nowPlaying = gm.getPlayer();
		nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
		v->setViewer(*gb);

		gm.changePlayer();		//返回原來對手步
		printViewer(v);
		button71->Visible = false;
		button72->Visible = false;
		button73->Visible = false;
		button74->Visible = false;
	}
	private: System::Void button74_Click(System::Object^ sender, System::EventArgs^ e) {
		//升階------------------------------------------------------------主教
		/*******************寫入********************/

				//  CLR 版本寫入
		StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
		String^ text = this->button74->TabIndex.ToString();		//寫入
		inFile->WriteLine(text);
		inFile->Close();		//寫入的關閉

		/*******************************************/
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		v->setViewer(*gb);
		gm.changePlayer();		//返回上個對手步
		nowPlaying = gm.getPlayer();
		nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
		v->setViewer(*gb);

		gm.changePlayer();		//返回原來對手步
		printViewer(v);
		button71->Visible = false;
		button72->Visible = false;
		button73->Visible = false;
		button74->Visible = false;
	}
	private: System::Void timer1_Tick(System::Object^ sender, System::EventArgs^ e) {
		//白方的計時器
		secondWhite--;
		label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
		if (secondWhite == 0)
		{
				/******讓檔案必定存在*****/
				StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
				inFile->Close();		//寫入的關閉
				/*************************/
				if (gm.getCurrnet() == 1)	//現在是黑
				{
					timer1->Stop();	//黑
				}
				else if (gm.getCurrnet() == 0)	//現在是白
				{
					timer2->Stop();
				}
				if (gm.getCurrnet() == 0)
				{
					MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
				}
				else
				{
					MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
				}

				/***************初始化，重新開始新的一局*****************/
				std::string mode = "human";
				GameManager resetGm(mode);
				Position resetUpPos;
				Player* resetNowPlaying;
				lastButtonIndex = -1;
				gm = resetGm;
				upPos = resetUpPos;
				nowPlaying = resetNowPlaying;
				gameOver = false;
				secondBlack = 3600;
				secondWhite = 3600;
				Board* gb = gm.getBoard();
				Viewer* v = gm.getViewer();
				v->setViewer(*gb);
				label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
				label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
				printViewer(v);
				/**********************************決定是否要回放*********************************/
				//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
				if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
				{
					//  I WANT TO REPLAY!!
					//  CLR 版本讀出
					String^ text = "";
					StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
					while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
					{
						int lastIndex = 0, NowIndex = 0;
						int i = 0, j = 0;
						for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
						{
							lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
						}
						i++;
						for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
						{
							NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
						}
						/********** MOVE1 **********/
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						int x, y;
						x = (lastIndex) % 8;
						y = (lastIndex) / 8;
						nowPlaying = gm.getPlayer();
						array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
										button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
										button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
										button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
										button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
										button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
										button61,  button62,  button63,  button64 };
						// MOVE 1
						nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
						printViewer(v);
						//將死
						if (nowPlaying->isChecked())
						{
							if (gm.getCurrnet() ^ 1 == 1)
							{
								for (int i = 0; i < 8; i++)
								{
									for (int j = 0; j < 8; j++)
									{
										if (v->getVBoard(j, i) == "WKing")
										{
											buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
												static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
										}
									}
								}

							}
							else
							{
								for (int i = 0; i < 8; i++)
								{
									for (int j = 0; j < 8; j++)
									{
										if (v->getVBoard(j, i) == "BKing")
										{
											buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
												static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
										}
									}
								}
							}
						}
						lastX = x;
						lastY = y;
						/***********************/

						MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

						/******** MOVE2  *******/
						gb = gm.getBoard();
						v = gm.getViewer();
						v->setViewer(*gb);
						nowPlaying = gm.getPlayer();
						x = (NowIndex) % 8;
						y = (NowIndex) / 8;
						Position to_pos;
						to_pos.x = x;
						to_pos.y = y;
						nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
						printViewer(v);
						//將軍和將死判斷
						if (nowPlaying->isChecked())
						{
							if (gm.getCurrnet() ^ 1 == 1)
							{
								for (int i = 0; i < 8; i++)
								{
									for (int j = 0; j < 8; j++)
									{
										if (v->getVBoard(j, i) == "WKing")
										{
											buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
												static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
										}
									}
								}

							}
							else
							{
								for (int i = 0; i < 8; i++)
								{
									for (int j = 0; j < 8; j++)
									{
										if (v->getVBoard(j, i) == "BKing")
										{
											buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
												static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
										}
									}
								}
							}
						}
						//
						if (nowPlaying->getMoved() == true)
						{
							nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
							nowPlaying->resetMoved();
							gm.changePlayer();
							gm.eat();
							/*********升階判斷***********/
							if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
							{
								/*nowPlaying->OnPromote(*gb, to_pos);*/
								//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
								/*button71->Visible = true;
								button72->Visible = true;
								button73->Visible = true;
								button74->Visible = true;*/
								upPos = to_pos;
								text = inFile->ReadLine();
								int upIndex;
								for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
								{
									upIndex = upIndex * pow(10, i) + (text[i] - '0');
								}
								if (upIndex == 81)
								{
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									gm.changePlayer();		//返回上個對手步
									nowPlaying = gm.getPlayer();
									nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
									v->setViewer(*gb);

									gm.changePlayer();		//返回原來對手步
									printViewer(v);
								}
								else if (upIndex == 82)
								{
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									gm.changePlayer();		//返回上個對手步
									nowPlaying = gm.getPlayer();
									nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
									v->setViewer(*gb);

									gm.changePlayer();		//返回原來對手步
									printViewer(v);
								}
								else if (upIndex == 83)
								{
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									gm.changePlayer();		//返回上個對手步
									nowPlaying = gm.getPlayer();
									nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
									v->setViewer(*gb);

									gm.changePlayer();		//返回原來對手步
									printViewer(v);
								}
								else if (upIndex == 84)
								{
									Board* gb = gm.getBoard();
									Viewer* v = gm.getViewer();
									v->setViewer(*gb);
									gm.changePlayer();		//返回上個對手步
									nowPlaying = gm.getPlayer();
									nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
									v->setViewer(*gb);

									gm.changePlayer();		//返回原來對手步
									printViewer(v);
								}
								upPos = to_pos;
							}
							gm.checkMate(gameOver);
							if (gameOver)
							{
								if (gm.getCurrnet() == 0)
								{
									MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
								}
								else
								{
									MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
								}
								/**********初始化************/
								std::string mode = "human";
								GameManager resetGm(mode);
								Position resetUpPos;
								Player* resetNowPlaying;
								lastButtonIndex = -1;
								gm = resetGm;
								upPos = resetUpPos;
								nowPlaying = resetNowPlaying;
								bool gameOver = false;
								secondBlack = 3600;
								secondWhite = 3600;
								Board* gb = gm.getBoard();
								Viewer* v = gm.getViewer();
								v->setViewer(*gb);
								label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
								label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
								printViewer(v);
								/****************************/

							}
							MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
						}
					}

					inFile->Close();			//回放結束，檔案關閉。
					remove(".\\GameLog.txt");
					MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
					gameOver = false;
				}
				/*****************************************************************************************/


				if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
				{
					MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
					Application::Exit();
				}
				else
				{
					/***************初始化，重新開始新的一局*****************/
					std::string mode = "human";
					GameManager resetGm(mode);
					Position resetUpPos;
					Player* resetNowPlaying;
					gm = resetGm;
					upPos = resetUpPos;
					nowPlaying = resetNowPlaying;
					bool gameOver = false;
					secondBlack = 3600;
					secondWhite = 3600;
					Board* gb = gm.getBoard();
					Viewer* v = gm.getViewer();
					v->setViewer(*gb);
					label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
					label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
					printViewer(v);
					MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
				}

				/***********************************************************/
		}

	}
private: System::Void label2_Click(System::Object^ sender, System::EventArgs^ e) {
}
private: System::Void label1_Click(System::Object^ sender, System::EventArgs^ e) {

}
private: System::Void timer2_Tick(System::Object^ sender, System::EventArgs^ e) {
	//白方的計時器
	secondBlack--;
	label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
	if (secondBlack == 0)
	{
		/******讓檔案必定存在*****/
		StreamWriter^ inFile = gcnew StreamWriter(".\\GameLog.txt", true);			//寫入的開啟
		inFile->Close();		//寫入的關閉
		/*************************/
		if (gm.getCurrnet() == 1)	//現在是黑
		{
			timer1->Stop();	//黑
		}
		else if (gm.getCurrnet() == 0)	//現在是白
		{
			timer2->Stop();
		}
		if (gm.getCurrnet() == 0)
		{
			MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
		}
		else
		{
			MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
		}

		/***************初始化，重新開始新的一局*****************/
		std::string mode = "human";
		GameManager resetGm(mode);
		Position resetUpPos;
		Player* resetNowPlaying;
		lastButtonIndex = -1;
		gm = resetGm;
		upPos = resetUpPos;
		nowPlaying = resetNowPlaying;
		gameOver = false;
		secondBlack = 3600;
		secondWhite = 3600;
		Board* gb = gm.getBoard();
		Viewer* v = gm.getViewer();
		v->setViewer(*gb);
		label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
		label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
		printViewer(v);
		/**********************************決定是否要回放*********************************/
		//基本架構跟一般遊戲相同，只是改成自動從檔案讀入
		if (MessageBox::Show("DO YOU WANT TO REPLAY THE LAST GAME?~", "回放詢問", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::Yes)
		{
			//  I WANT TO REPLAY!!
			//  CLR 版本讀出
			String^ text = "";
			StreamReader^ inFile = gcnew StreamReader(".\\GameLog.txt", true);		//回放的開啟
			while ((text = inFile->ReadLine()) != nullptr)	//開始逐行讀取回放
			{
				int lastIndex = 0, NowIndex = 0;
				int i = 0, j = 0;
				for (i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
				{
					lastIndex = lastIndex * pow(10, i) + (text[i] - '0');
				}
				i++;
				for (j = 0; (i < text->Length) && text[i] != ' '; i++, j++)		//字串轉回數字
				{
					NowIndex = NowIndex * pow(10, j) + (text[i] - '0');
				}
				/********** MOVE1 **********/
				Board* gb = gm.getBoard();
				Viewer* v = gm.getViewer();
				v->setViewer(*gb);
				int x, y;
				x = (lastIndex) % 8;
				y = (lastIndex) / 8;
				nowPlaying = gm.getPlayer();
				array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
								button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
								button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
								button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
								button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
								button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
								button61,  button62,  button63,  button64 };
				// MOVE 1
				nowPlaying->OnMove(*gb, *v, x, y, *gm.getOpponent(), gm.getCurrnet() ^ 1);
				printViewer(v);
				//將死
				if (nowPlaying->isChecked())
				{
					if (gm.getCurrnet() ^ 1 == 1)
					{
						for (int i = 0; i < 8; i++)
						{
							for (int j = 0; j < 8; j++)
							{
								if (v->getVBoard(j, i) == "WKing")
								{
									buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
										static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
								}
							}
						}

					}
					else
					{
						for (int i = 0; i < 8; i++)
						{
							for (int j = 0; j < 8; j++)
							{
								if (v->getVBoard(j, i) == "BKing")
								{
									buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
										static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
								}
							}
						}
					}
				}
				lastX = x;
				lastY = y;
				/***********************/

				MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG

				/******** MOVE2  *******/
				gb = gm.getBoard();
				v = gm.getViewer();
				v->setViewer(*gb);
				nowPlaying = gm.getPlayer();
				x = (NowIndex) % 8;
				y = (NowIndex) / 8;
				Position to_pos;
				to_pos.x = x;
				to_pos.y = y;
				nowPlaying->OnMove2(*gb, *v, x, y, lastX, lastY, *gm.getOpponent(), gm.getCurrnet() ^ 1);		//第二個按
				printViewer(v);
				//將軍和將死判斷
				if (nowPlaying->isChecked())
				{
					if (gm.getCurrnet() ^ 1 == 1)
					{
						for (int i = 0; i < 8; i++)
						{
							for (int j = 0; j < 8; j++)
							{
								if (v->getVBoard(j, i) == "WKing")
								{
									buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
										static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
								}
							}
						}

					}
					else
					{
						for (int i = 0; i < 8; i++)
						{
							for (int j = 0; j < 8; j++)
							{
								if (v->getVBoard(j, i) == "BKing")
								{
									buttonArray[j * 8 + i]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(0)),
										static_cast<System::Int32>(static_cast<System::Byte>(0)));	//大紅
								}
							}
						}
					}
				}
				//
				if (nowPlaying->getMoved() == true)
				{
					nowPlaying->check(gm.getCurrnet() ^ 1, *gm.getOpponent(), *v);
					nowPlaying->resetMoved();
					gm.changePlayer();
					gm.eat();
					/*********升階判斷***********/
					if (gb->getBoardElement(y, x).substr(1) == "Pawn" && (to_pos.y == 0 || to_pos.y == 7))
					{
						/*nowPlaying->OnPromote(*gb, to_pos);*/
						//MessageBox::Show("choose a piece of promotion (queen / rook / knight / bishop )", "升階", MessageBoxButtons::OK);		// Position
						/*button71->Visible = true;
						button72->Visible = true;
						button73->Visible = true;
						button74->Visible = true;*/
						upPos = to_pos;
						text = inFile->ReadLine();
						int upIndex;
						for (int i = 0; (i < text->Length) && text[i] != ' '; i++)		//字串轉回數字
						{
							upIndex = upIndex * pow(10, i) + (text[i] - '0');
						}
						if (upIndex == 81)
						{
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							gm.changePlayer();		//返回上個對手步
							nowPlaying = gm.getPlayer();
							nowPlaying->OnPromote(*gb, upPos, this->button71->TabIndex);
							v->setViewer(*gb);

							gm.changePlayer();		//返回原來對手步
							printViewer(v);
						}
						else if (upIndex == 82)
						{
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							gm.changePlayer();		//返回上個對手步
							nowPlaying = gm.getPlayer();
							nowPlaying->OnPromote(*gb, upPos, this->button72->TabIndex);
							v->setViewer(*gb);

							gm.changePlayer();		//返回原來對手步
							printViewer(v);
						}
						else if (upIndex == 83)
						{
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							gm.changePlayer();		//返回上個對手步
							nowPlaying = gm.getPlayer();
							nowPlaying->OnPromote(*gb, upPos, this->button73->TabIndex);
							v->setViewer(*gb);

							gm.changePlayer();		//返回原來對手步
							printViewer(v);
						}
						else if (upIndex == 84)
						{
							Board* gb = gm.getBoard();
							Viewer* v = gm.getViewer();
							v->setViewer(*gb);
							gm.changePlayer();		//返回上個對手步
							nowPlaying = gm.getPlayer();
							nowPlaying->OnPromote(*gb, upPos, this->button74->TabIndex);
							v->setViewer(*gb);

							gm.changePlayer();		//返回原來對手步
							printViewer(v);
						}
						upPos = to_pos;
					}
					gm.checkMate(gameOver);
					if (gameOver)
					{
						if (gm.getCurrnet() == 0)
						{
							MessageBox::Show("Winner is Black", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
						}
						else
						{
							MessageBox::Show("Winner is White", "遊戲結果", MessageBoxButtons::OK);		//Invalid Position
						}
						/**********初始化************/
						std::string mode = "human";
						GameManager resetGm(mode);
						Position resetUpPos;
						Player* resetNowPlaying;
						lastButtonIndex = -1;
						gm = resetGm;
						upPos = resetUpPos;
						nowPlaying = resetNowPlaying;
						bool gameOver = false;
						secondBlack = 3600;
						secondWhite = 3600;
						Board* gb = gm.getBoard();
						Viewer* v = gm.getViewer();
						v->setViewer(*gb);
						label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
						label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
						printViewer(v);
						/****************************/

					}
					MessageBox::Show("下一步", "回放", MessageBoxButtons::OK);		// DEBUG
				}
			}

			inFile->Close();			//回放結束，檔案關閉。
			remove(".\\GameLog.txt");
			MessageBox::Show("回放結束", "回放結束", MessageBoxButtons::OK);		// DEBUG
			gameOver = false;
		}
		/*****************************************************************************************/


		if (MessageBox::Show("DO YOU WANT TO PLAY THE GAME?~", "遊戲開始", MessageBoxButtons::YesNo) == System::Windows::Forms::DialogResult::No)		//GAME  START   or   EXIT  !!
		{
			MessageBox::Show("BYEBYE~", "謝謝光臨", MessageBoxButtons::OK);
			Application::Exit();
		}
		else
		{
			/***************初始化，重新開始新的一局*****************/
			std::string mode = "human";
			GameManager resetGm(mode);
			Position resetUpPos;
			Player* resetNowPlaying;
			gm = resetGm;
			upPos = resetUpPos;
			nowPlaying = resetNowPlaying;
			bool gameOver = false;
			secondBlack = 3600;
			secondWhite = 3600;
			Board* gb = gm.getBoard();
			Viewer* v = gm.getViewer();
			v->setViewer(*gb);
			label2->Text = Convert::ToString(secondWhite / 60) + " : " + Convert::ToString(secondWhite % 60);
			label1->Text = Convert::ToString(secondBlack / 60) + " : " + Convert::ToString(secondBlack % 60);
			printViewer(v);
			MessageBox::Show("STARY !!", "歡迎光臨", MessageBoxButtons::OK);
		}

		/***********************************************************/
	}

}
};
}


/*array<Button^>^ buttonArray = { button1, button2, button3,  button4,  button5,  button6,  button7,  button8,  button9,  button10,
									button11,  button12,  button13,  button14,  button15,  button16,  button17,  button18,  button19,  button20,
									button21,  button22,  button23,  button24,  button25,  button26,  button27,  button28,  button29,  button30,
									button31,  button32,  button33,  button34,  button35,  button36,  button37,  button38,  button39,  button40,
									button41,  button42,  button43,  button44,  button45,  button46,  button47,  button48,  button49,  button50,
									button51,  button52,  button53,  button54,  button55,  button56,  button57,  button58,  button59,  button60,
									button61,  button62,  button63,  button64 };
	buttonArray[0]->BackColor = System::Drawing::Color::FromArgb(static_cast<System::Int32>(static_cast<System::Byte>(255)), static_cast<System::Int32>(static_cast<System::Byte>(148)),
		static_cast<System::Int32>(static_cast<System::Byte>(40)));*/